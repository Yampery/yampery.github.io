<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="天尽头，回眸望红尘" type="application/atom+xml" />






<meta property="og:type" content="website">
<meta property="og:title" content="天尽头，回眸望红尘">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="天尽头，回眸望红尘">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="天尽头，回眸望红尘">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>天尽头，回眸望红尘</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">天尽头，回眸望红尘</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/29/distcp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yampery">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天尽头，回眸望红尘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/29/distcp/" itemprop="url">Hadoop集群间文件拷贝</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-29T15:24:07+08:00">
                2019-01-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2019/01/29/distcp/" class="leancloud_visitors" data-flag-title="Hadoop集群间文件拷贝">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="distcp使用"><a href="#distcp使用" class="headerlink" title="distcp使用"></a>distcp使用</h1><blockquote>
<p>DistCp Version 2(分布式copy)是用于集群间/集群内的文件copy工具，
使用MapReduce实现分布式、错误处理、恢复和报告。distCp会根据目录文件生成map任务，
每一个任务会copy部分文件内容。</p>
</blockquote>
<hr>
<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><ul>
<li><p>最常使用的是集群间copy</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop distcp hdfs://nn1:8020/foo/bar hdfs://nn2:8020/bar/foo</span><br></pre></td></tr></table></figure>
<blockquote>
<p>该命令会将nn1下的<code>/foo/bar</code>放在一个临时文件里，并将内容分割为一系列<code>map tasts</code>，</p>
</blockquote>
<p>  然后在每一个<code>NodeManage</code>r上从nn1向nn2拷贝。</p>
<p>  也可在命令行指定多个源文件</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hadoop distcp hdfs://nn1:8020/foo/a </span><br><span class="line">   hdfs://nn1:8020/foo/b </span><br><span class="line">   hdfs://nn2:8020/bar/foo</span><br></pre></td></tr></table></figure>
<p>  同样的，使用-f指定文件，<code>srclist</code>包含a和b</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hadoop distcp -f hdfs://nn1:8020/srclist </span><br><span class="line">  	hdfs://nn2:8020/bar/foo</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在多源<code>copy</code>中，如果源文件冲突，<code>distCp</code>将会终止并发送错误报告，而在目标上的冲突将会根据指定的选项（<code>option</code>）处理。默认情况下，跳过目标集群已经存在的文件而不是替换，跳过文件的数量将会在任务结束的时候报告。不过，如果存在copy任务失败，后续重试成功的情况，任务最终报告的跳过文件的数量将会不准确。</p>
</blockquote>
<blockquote>
<p><strong>注意：每个<code>NodeManager</code>都必须与源文件系统、目标文件系统正常通信。对HDFS来说，源集群和目标集群必须是同一个协议版本（并非组件版本强一致），或使用向下兼容协议</strong></p>
</blockquote>
<blockquote>
<p>Copy完成之后，最好进行产出、交叉验证，保证集群间copy结果无误。</p>
</blockquote>
<blockquote>
<p><strong>如果源集群存在客户端写操作，<code>copy</code>任务很可能会失败，尝试覆盖一个在目标集群上正在写的文件也会失败，如果在copy任务开始之前，源文件被删除，<code>copy</code>任务将会失败并抛出<code>FileNotFoundException</code></strong></p>
</blockquote>
</li>
</ul>
<hr>
<h2 id="Update-和-Overwrite"><a href="#Update-和-Overwrite" class="headerlink" title="Update 和 Overwrite"></a>Update 和 Overwrite</h2><pre><code>`-update` 用来从源集群复制目标集群不存在或者版本不一致的文件. `-overwrite` 用于在目标集群如果存在相同的文件时进行覆盖。
</code></pre><ul>
<li><p>例如：从 <code>/source/first/</code> 何 <code>/source/second/</code> 复制到 <code>/target/</code></p>
<p>  源集群有以下文件</p>
<pre><code>hdfs://nn1:8020/source/first/1
hdfs://nn1:8020/source/first/2
hdfs://nn1:8020/source/second/10
hdfs://nn1:8020/source/second/20
</code></pre><p>   当distCp没有使用<code>-update</code> or <code>-overwrite</code>, distCp 默认将会在<code>/target</code>下创建 <code>first/</code> 和 <code>second/</code>，例如:</p>
<pre><code><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">distcp hdfs://nn1:8020/<span class="built_in">source</span>/first hdfs://nn1:8020/<span class="built_in">source</span>/second hdfs://nn2:8020/target</span><br></pre></td></tr></table></figure>
</code></pre><p>  在目标文件夹<code>/target</code>下产生以下内容：</p>
<pre><code> hdfs://nn2:8020/target/first/1
 hdfs://nn2:8020/target/first/2
 hdfs://nn2:8020/target/second/10
 hdfs://nn2:8020/target/second/20

当指定 `-update` 或 `-overwrite`, 会将源目录下的内容copy到目标下, 而不是源目录，例如:
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">distcp -update hdfs://nn1:8020/<span class="built_in">source</span>/first hdfs://nn1:8020/<span class="built_in">source</span>/second hdfs://nn2:8020/target</span><br></pre></td></tr></table></figure>
</code></pre><p>  在目标文件夹<code>/target</code>下产生以下内容：</p>
<pre><code>hdfs://nn2:8020/target/1
hdfs://nn2:8020/target/2
hdfs://nn2:8020/target/10
hdfs://nn2:8020/target/20
</code></pre><p>  <strong>如果所有源文件都包含同一个文件(如, <code>0</code>)，那所有的源文件都会在目标文件映射一个 <code>/target/0</code> 的实体，DistCp将会失败。</strong></p>
<p>  考虑如下copy操作</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">distcp hdfs://nn1:8020/<span class="built_in">source</span>/first hdfs://nn1:8020/<span class="built_in">source</span>/second hdfs://nn2:8020/target</span><br></pre></td></tr></table></figure>
<p>  源集群上源文件/大小</p>
<pre><code>hdfs://nn1:8020/source/first/1 32
hdfs://nn1:8020/source/first/2 32
hdfs://nn1:8020/source/second/10 64
hdfs://nn1:8020/source/second/20 32
</code></pre><p>  目标集群上文件/大小</p>
<pre><code>hdfs://nn2:8020/target/1 32
hdfs://nn2:8020/target/10 32
hdfs://nn2:8020/target/20 64
</code></pre><p>  将会导致</p>
<pre><code>hdfs://nn2:8020/target/1 32
hdfs://nn2:8020/target/2 32
hdfs://nn2:8020/target/10 64
hdfs://nn2:8020/target/20 32
</code></pre><ul>
<li><code>1</code> 由于大小和内容一致，将会跳过；</li>
<li><code>2</code> 由于不存在，将会直接copy；</li>
<li><code>10</code> 和 <code>20</code> 由于内容不一致，将会覆盖；</li>
<li>如果使用 <code>-update</code>, <code>1</code> 也会被覆盖。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="DistCp体系结构"><a href="#DistCp体系结构" class="headerlink" title="DistCp体系结构"></a>DistCp体系结构</h2><p>DistCp主要有以下三个组件组成:</p>
<ul>
<li>DistCp Driver</li>
<li>Copy-listing generator</li>
<li>Input-formats 和 Map-Reduce components</li>
</ul>
<h3 id="DistCp-Driver"><a href="#DistCp-Driver" class="headerlink" title="DistCp Driver"></a>DistCp Driver</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造方法，根据输入的参数创建DistCp</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DistCp</span><span class="params">(Configuration configuration, DistCpOptions inputOptions)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Configuration config = <span class="keyword">new</span> Configuration(configuration);</span><br><span class="line">    config.addResource(DISTCP_DEFAULT_XML);</span><br><span class="line">    setConf(config);</span><br><span class="line">    <span class="keyword">this</span>.inputOptions = inputOptions;</span><br><span class="line">    <span class="keyword">this</span>.metaFolder   = createMetaFolderPath();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 实现 Tool::run(). 组织源文件拷贝到目标位置</span></span><br><span class="line"><span class="comment"> *  1. 创建将要拷贝到目标的文件列表</span></span><br><span class="line"><span class="comment"> *  2. 运行Map任务. (委托给 execute().)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> argv List of arguments passed to DistCp, from the ToolRunner.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> On success, it returns 0. Else, -1.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argv.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">      OptionsParser.usage();</span><br><span class="line">      <span class="keyword">return</span> DistCpConstants.INVALID_ARGUMENT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      inputOptions = (OptionsParser.parse(argv));</span><br><span class="line">      setTargetPathExists();</span><br><span class="line">      LOG.info(<span class="string">"Input Options: "</span> + inputOptions);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">      LOG.error(<span class="string">"Invalid arguments: "</span>, e);</span><br><span class="line">      System.err.println(<span class="string">"Invalid arguments: "</span> + e.getMessage());</span><br><span class="line">      OptionsParser.usage();      </span><br><span class="line">      <span class="keyword">return</span> DistCpConstants.INVALID_ARGUMENT;</span><br><span class="line">    &#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  DistCp Driver 组件负责以下内容:</p>
<ul>
<li><p>将命令行命令参数解析传给DistCp, 通过:</p>
<ul>
<li>OptionsParser： 通过 <code>public static DistCpOptions parse(String args[]);</code> 方法解析命令行参数，并创建相关的Options对象；</li>
<li>DistCpOptionsSwitch： <code>public enum DistCpOptionSwitch</code>, 一个枚举类，与命令行参数的key（-i, -p）相映射。</li>
</ul>
</li>
<li><p>将命令参数封装在合适的 <code>DistCpOptions</code> 对象中，初始化 <code>DistCp</code>，参数包括：</p>
<ul>
<li>源路径</li>
<li>目标位置</li>
<li>复制选项 (例如：是否采用 <code>update</code>、<code>overwrite</code> 复制，保留文件那些属性等。)</li>
</ul>
</li>
</ul>
<ul>
<li><p>通过以下过程组织copy</p>
<ul>
<li>调用copy-listing-generator 创建要copy的文件列表；</li>
<li>构件并执行 <code>Map-Reduce</code> 来执行copy；</li>
<li>Based on the options, either returning a handle to the Hadoop MR Job
immediately, or waiting till completion.</li>
<li>基于用户指定的选项，立即返回MR任务操作或等待任务完成。</li>
</ul>
</li>
<li><p>Copy-Listing 生成器</p>
<p>The copy-listing-generator类负责创建源集群要复制的文件/文件夹列表。检验源路径中的内容，记录所有需要copy到SequenceFile中的paths，供DistCp消费。其主要包括以下模块：</p>
<ol>
<li>CopyListing: 上层接口，具体的copy-listing-generator通过实现此接口来实现列表生成功能。提供工厂方法供构造CopyListing的实现来选择； </li>
</ol>
<p><img src="https://i.imgur.com/EjuUxrL.png" alt=""></p>
<ol start="2">
<li>SimpleCopyListing: CopyListing的一个实现，接收多源路径，并且递归地列出每个path下的所有单独文件和目录，用于copy；</li>
<li>GlobbedCopyListing: CopyListing的一个实现，支持源路径存在通配符；</li>
<li>FileBasedCopyListing: CopyListing的一个实现，从一个指定文件中读取源路径列表；</li>
</ol>
</li>
</ul>
<pre><code>根据是否在DistCpOptions中指定源文件列表，source-list通过以下方式生成：

1. 如果没有指定source-file-list, 使用GlobbedCopyListing。 扩展所有的通配符，所有扩展发送给SimpleCopyListing，依次构造listing(通过向下递归方式)；
2. 如果指定source-file-list, 使用FileBasedCopyListing。从指定的文件中读取Source-paths, 然后发送给GlobbedCopyListing，像上面一样构造listing。

GlobbedCopyListing构造listing如下：
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doBuildListing</span><span class="params">(Path pathToListingFile,</span></span></span><br><span class="line"><span class="function"><span class="params">                           DistCpOptions options)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">  List&lt;Path&gt; globbedPaths = <span class="keyword">new</span> ArrayList&lt;Path&gt;();</span><br><span class="line">  <span class="keyword">if</span> (options.getSourcePaths().isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> InvalidInputException(<span class="string">"Nothing to process. Source paths::EMPTY"</span>);  </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (Path p : options.getSourcePaths()) &#123;</span><br><span class="line">    FileSystem fs = p.getFileSystem(getConf());</span><br><span class="line">    FileStatus[] inputs = fs.globStatus(p);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(inputs != <span class="keyword">null</span> &amp;&amp; inputs.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (FileStatus onePath: inputs) &#123;</span><br><span class="line">        globbedPaths.add(onePath.getPath());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> InvalidInputException(p + <span class="string">" doesn't exist"</span>);        </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  DistCpOptions optionsGlobbed = <span class="keyword">new</span> DistCpOptions(options);</span><br><span class="line">  optionsGlobbed.setSourcePaths(globbedPaths);</span><br><span class="line">  simpleListing.buildListing(pathToListingFile, optionsGlobbed);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="InputFormats-和-MapReduce-组件"><a href="#InputFormats-和-MapReduce-组件" class="headerlink" title="InputFormats 和 MapReduce 组件"></a>InputFormats 和 MapReduce 组件</h3><p>  这两个组件负责实际上从源到目标的文件复制。当copy开始实行时，在copy-listing时生成的listing-file此时将被消费。</p>
<blockquote>
<p>Hadoop中，InputFormat接口定义的方法就是如何读取文件和分割文件以提供分片给mapper。
InputSplit算是Hadoop的一种存储格式，是Hadoop定义的用来传送给每个单独的map的数据，InputSplit存储的并非数据本身，而是一个分片长度和一个记录数据位置的数组。生成InputSplit的方法可以通过InputFormat来设置。</p>
</blockquote>
<ul>
<li><strong>UniformSizeInputFormat:</strong>
实现了 <code>org.apache.hadoop.mapreduce.InputFormat</code>. UniformSizeInputFormat的宗旨是使每个map任务大约有相同的字节数量。
通过配置文件确定map数量和每个map任务的字节数，map数量通过JobContex配置，总copy字节数通过DistCp常量配置。</li>
</ul>
<pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;InputSplit&gt; <span class="title">getSplits</span><span class="params">(Configuration configuration, <span class="keyword">int</span> numSplits, <span class="keyword">long</span> totalSizeBytes)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            List&lt;InputSplit&gt; splits = <span class="keyword">new</span> ArrayList&lt;InputSplit&gt;(numSplits);</span><br><span class="line">              <span class="keyword">long</span> nBytesPerSplit = (<span class="keyword">long</span>) Math.ceil(totalSizeBytes * <span class="number">1.0</span> / numSplits);</span><br><span class="line">          </span><br><span class="line">              CopyListingFileStatus srcFileStatus = <span class="keyword">new</span> CopyListingFileStatus();</span><br><span class="line">              Text srcRelPath = <span class="keyword">new</span> Text();</span><br><span class="line">              <span class="keyword">long</span> currentSplitSize = <span class="number">0</span>;</span><br><span class="line">              <span class="keyword">long</span> lastSplitStart = <span class="number">0</span>;</span><br><span class="line">              <span class="keyword">long</span> lastPosition = <span class="number">0</span>;</span><br><span class="line">          </span><br><span class="line">              <span class="keyword">final</span> Path listingFilePath = getListingFilePath(configuration);</span><br><span class="line">          </span><br><span class="line">              <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                LOG.debug(<span class="string">"Average bytes per map: "</span> + nBytesPerSplit +</span><br><span class="line">                    <span class="string">", Number of maps: "</span> + numSplits + <span class="string">", total size: "</span> + totalSizeBytes);</span><br><span class="line">              &#125;</span><br><span class="line">              SequenceFile.Reader reader=<span class="keyword">null</span>;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                reader = getListingFileReader(configuration);</span><br><span class="line">                <span class="keyword">while</span> (reader.next(srcRelPath, srcFileStatus)) &#123;</span><br><span class="line">                  <span class="comment">// 如果添加该文件导致每个map超出了最大字节数限制，将当前文件添加到新的split</span></span><br><span class="line">                  <span class="keyword">if</span> (currentSplitSize + srcFileStatus.getLen() &gt; nBytesPerSplit &amp;&amp; lastPosition != <span class="number">0</span>) &#123;</span><br><span class="line">                    FileSplit split = <span class="keyword">new</span> FileSplit(listingFilePath, lastSplitStart,</span><br><span class="line">                        lastPosition - lastSplitStart, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                      LOG.debug (<span class="string">"Creating split : "</span> + split + <span class="string">", bytes in split: "</span> + currentSplitSize);</span><br><span class="line">                    &#125;</span><br><span class="line">                    splits.add(split);</span><br><span class="line">                    lastSplitStart = lastPosition;</span><br><span class="line">                    currentSplitSize = <span class="number">0</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                  currentSplitSize += srcFileStatus.getLen();</span><br><span class="line">                  lastPosition = reader.getPosition();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (lastPosition &gt; lastSplitStart) &#123;</span><br><span class="line">                  FileSplit split = <span class="keyword">new</span> FileSplit(listingFilePath, lastSplitStart,</span><br><span class="line">                      lastPosition - lastSplitStart, <span class="keyword">null</span>);</span><br><span class="line">                  <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                    LOG.info (<span class="string">"Creating split : "</span> + split + <span class="string">", bytes in split: "</span> + currentSplitSize);</span><br><span class="line">                  &#125;</span><br><span class="line">                  splits.add(split);</span><br><span class="line">                &#125;</span><br><span class="line">          </span><br><span class="line">              &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                IOUtils.closeStream(reader);</span><br><span class="line">              &#125;</span><br><span class="line">          </span><br><span class="line">              <span class="keyword">return</span> splits;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
</code></pre><ul>
<li><p><strong>DynamicInputFormat and DynamicRecordReader:</strong>
DynamicInputFormat 实现了 <code>org.apache.hadoop.mapreduce.InputFormat</code>，
在DFS上将copy-list分成一个个chunk，创建一系列splits，每个split根据自己的能力消费chunks，这种模式可以避免最慢的mapper拖累整个任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> List&lt;InputSplit&gt; <span class="title">createSplits</span><span class="params">(JobContext jobContext,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      List&lt;DynamicInputChunk&gt; chunks)</span></span></span><br><span class="line"><span class="function">	<span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> numMaps = getNumMapTasks(jobContext.getConfiguration());</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">final</span> <span class="keyword">int</span> nSplits = Math.min(numMaps, chunks.size());</span><br><span class="line">	List&lt;InputSplit&gt; splits = <span class="keyword">new</span> ArrayList&lt;InputSplit&gt;(nSplits);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt; nSplits; ++i) &#123;</span><br><span class="line">	  TaskID taskId = <span class="keyword">new</span> TaskID(jobContext.getJobID(), TaskType.MAP, i);</span><br><span class="line">	  chunks.get(i).assignTo(taskId);</span><br><span class="line">	  splits.add(<span class="keyword">new</span> FileSplit(chunks.get(i).getPath(), <span class="number">0</span>,</span><br><span class="line">	      <span class="comment">// Setting non-zero length for FileSplit size, to avoid a possible</span></span><br><span class="line">	      <span class="comment">// future when 0-sized file-splits are considered "empty" and skipped</span></span><br><span class="line">	      <span class="comment">// over.</span></span><br><span class="line">	      getMinRecordsPerChunk(jobContext.getConfiguration()),</span><br><span class="line">	      <span class="keyword">null</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	DistCpUtils.publish(jobContext.getConfiguration(),</span><br><span class="line">	                    CONF_LABEL_NUM_SPLITS, splits.size());</span><br><span class="line">	<span class="keyword">return</span> splits;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DynamicRecordReader 配合DynamicInputFormat实现一种’Worker-pattern’复制，保证能者多劳，主要干两件事：</p>
<ol>
<li>将每个chunk的内容递交给DistCp的mapper；</li>
<li>当当前chunk消费完后，立即获取下一个chunk。  </li>
</ol>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">nextKeyValue</span><span class="params">()</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">if</span> (chunk == <span class="keyword">null</span>) &#123;</span><br><span class="line">	      <span class="keyword">if</span> (LOG.isDebugEnabled())</span><br><span class="line">	        LOG.debug(taskId + <span class="string">": RecordReader is null. No records to be read."</span>);</span><br><span class="line">	      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	</span><br><span class="line">	    <span class="keyword">if</span> (chunk.getReader().nextKeyValue()) &#123;</span><br><span class="line">	      ++numRecordsProcessedByThisMap;</span><br><span class="line">	      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	</span><br><span class="line">	    <span class="keyword">if</span> (LOG.isDebugEnabled())</span><br><span class="line">	      LOG.debug(taskId + <span class="string">": Current chunk exhausted. "</span> +</span><br><span class="line">	                         <span class="string">" Attempting to pick up new one."</span>);</span><br><span class="line">	</span><br><span class="line">	    chunk.release();</span><br><span class="line">	    timeOfLastChunkDirScan = System.currentTimeMillis();</span><br><span class="line">	    isChunkDirAlreadyScanned = <span class="keyword">false</span>;</span><br><span class="line">	    </span><br><span class="line">	    chunk = chunkContext.acquire(taskAttemptContext);</span><br><span class="line">	</span><br><span class="line">	    <span class="keyword">if</span> (chunk == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	</span><br><span class="line">	    <span class="keyword">if</span> (chunk.getReader().nextKeyValue()) &#123;</span><br><span class="line">	      ++numRecordsProcessedByThisMap;</span><br><span class="line">	      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">else</span> &#123;</span><br><span class="line">	      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">  	&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>CopyMapper:</strong>
实现 <code>Mapper</code>, 该类实现物理上的文件拷贝. 输入路径，参照指定参数决定是否拷贝文件. 只有出现以下情形之一，文件才会被拷贝:</p>
<ul>
<li>目标不存在同名文件；</li>
<li>目标上存在同名文件，但文件大小不同；</li>
<li>目标上存在同名文件，但是文件校验和不同，并且没有指定 <code>-skipcrccheck</code>；</li>
<li>目标上存在同名文件，但是指定了 <code>-overwrite</code>；</li>
<li>标上存在同名的文件, 但在块大小上有所不同（块大小需要被保留）。</li>
</ul>
</li>
<li><p><strong>CopyCommitter:</strong> 继承了 <code>FileOutputCommitter</code>, 负责DistCp的任务提交阶段:</p>
<ul>
<li>维护目录访问权限（如果指定了相应参数）；</li>
<li>清理元文件夹、临时文件（meta-folder, DistCp维护的文件表）；</li>
<li>将数据从临时工作文件夹原子移动（atom-move）到最终路径（如果指定atomic-commit）；</li>
<li>从目标上删除源上丢失的的文件（如果指定操作）；</li>
<li>清理所有不完全拷贝文件。</li>
</ul>
</li>
</ul>
<h2 id="Map-sizing"><a href="#Map-sizing" class="headerlink" title="Map sizing"></a>Map sizing</h2><p>  默认地，DistCp尝试以可比较地调整每个map的大小，让其拷贝大约相同字节数量。注意，文件是最好的粒度级别，因此，增加并行的copier（map）的数量并不总能相应的提高并行拷贝的数量和总的吞吐量。</p>
<p>  新的DistCp同时提供一种策略来”动态”调整maps大小的，允许较快的data-nodes扶正更多的字节。使用 <code>-strategy dynamic</code>, 将文件（files）分割成多个sets，而不是为每个map任务分配固定的源文件集合。sets的数量限制maps的数量，通常使用因子2-3，每个map获取并拷贝一个chunk中所有列出的文件。当一个使用完一个chunk，会获取并处理一个新的chunk，直到没有更多的chunks。</p>
<p>  最终，处理速度较快的map任务将会处理更多的chunks，就mapper的处理能力来看，是公平的。</p>
<p>  这种动态策略通过DynamicInputFormat实现。大多数情况下能够获得较好的性能。</p>
<p>  对于长时间运行、周期性的任务，建议将maps的数量调整为源群集和目标群集的大小、副本的大小以及可用带宽。（Tuning the number of maps to the size of the source and destination clusters,
  the size of the copy, and the available bandwidth is recommended for
  long-running and regularly run jobs.）</p>
<hr>
<h2 id="不同版本间拷贝"><a href="#不同版本间拷贝" class="headerlink" title="不同版本间拷贝"></a>不同版本间拷贝</h2><p>  对于两个不同主版本Hadoop之间的拷贝来说(例如：1.X和2.X)，其中一个通常使用 <code>WebHdfsFileSystem</code>，不同于 <code>HftpFileSystem</code>，webhdfs适用于读和写操作，hftp是只读操作。DistCp可以运行在源集群或目标集群上。远程集群指定 <code>webhdfs://&lt;namenode_hostname&gt;:&lt;http_port&gt;</code>。当主版本相同时，使用hdfs协议性能会更好。</p>
<hr>
<h2 id="MapReduce-和-其他副作用"><a href="#MapReduce-和-其他副作用" class="headerlink" title="MapReduce 和 其他副作用"></a>MapReduce 和 其他副作用</h2><p>  As has been mentioned in the preceding, should a map fail to copy one of its
  inputs, there will be several side-effects.
  之前提到过，万一一个map拷贝inputs（属于该map的）中的一个失败了，将会带来一些副作用：</p>
<ul>
<li>除非指定了 <code>-overwrite</code>，否则之前的map成功拷贝的文件将被标记为”skipped”；</li>
<li>如果一个map在尝试最大次数(<code>mapreduce.map.maxattempts</code>)后失败，剩下的map任务将被杀死(除非指定 <code>-i</code>)；</li>
<li>If <code>mapreduce.map.speculative</code> is set set final and true, the result of the
copy is undefined.</li>
<li>如果设置 <code>mapreduce.map.speculative</code>(<em>hadoop的推测执行，通常集群中的机器配置差异较大才会打开</em>) 为 “true”，拷贝的结果是未定义。</li>
</ul>
<hr>
<h1 id="从源码理解DistCp"><a href="#从源码理解DistCp" class="headerlink" title="从源码理解DistCp"></a>从源码理解DistCp</h1><h2 id="DistCp"><a href="#DistCp" class="headerlink" title="DistCp"></a>DistCp</h2><p>DistCp实现Tool，这样可以使用ToolRunner调度。ToolRunner调度器执行时，调用DistCp的run()方法，一切从这里开始。</p>
<p>阅读DistCp的构造器，首先在DistCp初始化时处理了配置、命令参数等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DistCp</span><span class="params">(Configuration configuration, DistCpOptions inputOptions)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	Configuration config = <span class="keyword">new</span> Configuration(configuration);</span><br><span class="line">	config.addResource(DISTCP_DEFAULT_XML);</span><br><span class="line">	setConf(config);</span><br><span class="line">	<span class="keyword">this</span>.inputOptions = inputOptions;</span><br><span class="line">	<span class="keyword">this</span>.metaFolder   = createMetaFolderPath();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>run()是一个调度方法，调起execute()，校验输入、处理异常等，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调度方法，省掉了部分catch</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] argv)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (argv.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">	  OptionsParser.usage();</span><br><span class="line">	  <span class="keyword">return</span> DistCpConstants.INVALID_ARGUMENT;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	  inputOptions = (OptionsParser.parse(argv));</span><br><span class="line">	  setTargetPathExists();</span><br><span class="line">	  LOG.info(<span class="string">"Input Options: "</span> + inputOptions);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">	  </span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	  execute(); <span class="comment">// 调用执行</span></span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">	  LOG.error(<span class="string">"Exception encountered "</span>, e);</span><br><span class="line">	  <span class="keyword">return</span> DistCpConstants.UNKNOWN_ERROR;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> DistCpConstants.SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Job <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	Job job = createAndSubmitJob();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (inputOptions.shouldBlock()) &#123;</span><br><span class="line">	  waitForJobCompletion(job);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> job;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>excute()方法是执行任务，调用createAndSubmitJob()，该方法创建并提交任务到hadoop集群运行。
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建并提交MR任务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 已提交的MR任务实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Job <span class="title">createAndSubmitJob</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> inputOptions != <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">assert</span> <span class="title">getConf</span><span class="params">()</span> !</span>= <span class="keyword">null</span>;</span><br><span class="line">    Job job = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//Don't cleanup while we are setting up.</span></span><br><span class="line">        metaFolder = createMetaFolderPath();</span><br><span class="line">        jobFS = metaFolder.getFileSystem(getConf());</span><br><span class="line">        job = createJob();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (inputOptions.shouldUseDiff()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!DistCpSync.sync(inputOptions, getConf())) &#123;</span><br><span class="line">          inputOptions.disableUsingDiff();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      createInputFileListing(job);</span><br><span class="line"></span><br><span class="line">      job.submit();</span><br><span class="line">      submitted = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!submitted) &#123;</span><br><span class="line">        cleanup();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String jobID = job.getJobID().toString();</span><br><span class="line">    job.getConfiguration().set(DistCpConstants.CONF_LABEL_DISTCP_JOB_ID, jobID);</span><br><span class="line">    LOG.info(<span class="string">"DistCp job-id: "</span> + jobID);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> job;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面分析源码中的几个关键字。</p>
<h3 id="metaFolder"><a href="#metaFolder" class="headerlink" title="metaFolder"></a>metaFolder</h3><p>在DistCp中定义为 <code>private Path metaFolder</code>，是一个 <code>org.apache.hadoop.fs.Path</code> 类型，顾名思义，是准备元数据的地方。</p>
<ul>
<li><p>createMetaFolderPath</p>
<p>  结合一个随机数生成一个临时目录。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Path <span class="title">createMetaFolderPath</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	Configuration configuration = getConf();</span><br><span class="line">	Path stagingDir = JobSubmissionFiles.getStagingDir(</span><br><span class="line">	        <span class="keyword">new</span> Cluster(configuration), configuration);</span><br><span class="line">	Path metaFolderPath = <span class="keyword">new</span> Path(stagingDir, PREFIX + String.valueOf(rand.nextInt()));</span><br><span class="line">	<span class="keyword">if</span> (LOG.isDebugEnabled())</span><br><span class="line">	  LOG.debug(<span class="string">"Meta folder location: "</span> + metaFolderPath);</span><br><span class="line">	configuration.set(DistCpConstants.CONF_LABEL_META_FOLDER, metaFolderPath.toString());    </span><br><span class="line">	<span class="keyword">return</span> metaFolderPath;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>createInputFileListing(Job job)</p>
<p>  注意到在metaFolder下，通过getFileListingPath()生成fileList.seq文件，稍后会往fileList.seq中写入数据，这是一个SequenceFile文件，SequenceFile是一个由二进制序列化过的key/value的字节流组成的文本存储文件，这个文件里将存放所有需要拷贝的源目录/文件信息列表。我们下面将介绍fileList.seq文件。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Path <span class="title">createInputFileListing</span><span class="params">(Job job)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  Path fileListingPath = getFileListingPath();</span><br><span class="line">  CopyListing copyListing = CopyListing.getCopyListing(job.getConfiguration(),</span><br><span class="line">      job.getCredentials(), inputOptions);</span><br><span class="line">  copyListing.buildListing(fileListingPath, inputOptions);</span><br><span class="line">  <span class="keyword">return</span> fileListingPath;</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">protected</span> Path <span class="title">getFileListingPath</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  String fileListPathStr = metaFolder + <span class="string">"/fileList.seq"</span>;</span><br><span class="line">  Path path = <span class="keyword">new</span> Path(fileListPathStr);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Path(path.toUri().normalize().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="fileList-seq文件"><a href="#fileList-seq文件" class="headerlink" title="fileList.seq文件"></a>fileList.seq文件</h3><p>这个文件里将存放所有需要拷贝的源目录/文件信息列表，注意到上面 <code>createInputFileListing</code> 中的 <code>copyListing.buildListing(fileListingPath, inputOptions)</code> 方法，如前所述，CopyListing有三种实现，最终都调用了其中SimpleCopyList类的buildList方法，该方法就是用来收集要拷贝的文件列表并写入fileList.seq文件，如下简略代码中，第一个参数就是Hadoop的Writer，通过 <code>getWriter(Path)</code> 获取。写入SequenceFile中的Key是源文件的Text格式的相对路径，即relPath；而Value则记录源文件的FileStatus格式的org.apache.hadoop.fs.FileStatus信息，这里FileStatus是hadoop已经封装好了的描述HDFS文件信息的类，但是DISTCP为了更好的处理数据，重新继承并封装了CopyListingFileStatus类。如下图，主要增加了aclEntries和xAttrs成员变量，关于文件权限和属性的，并覆盖了图中的方法。</p>
<p><img src="https://i.imgur.com/38o3TKy.png" alt="">
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doBuildListing</span><span class="params">(SequenceFile.Writer fileListWriter,</span></span></span><br><span class="line"><span class="function"><span class="params">    DistCpOptions options)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="comment">// 省略...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> SequenceFile.<span class="function">Writer <span class="title">getWriter</span><span class="params">(Path pathToListFile)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  FileSystem fs = pathToListFile.getFileSystem(getConf());</span><br><span class="line">  <span class="keyword">if</span> (fs.exists(pathToListFile)) &#123;</span><br><span class="line">    fs.delete(pathToListFile, <span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> SequenceFile.createWriter(getConf(),</span><br><span class="line">          SequenceFile.Writer.file(pathToListFile),</span><br><span class="line">          SequenceFile.Writer.keyClass(Text.class),</span><br><span class="line">          SequenceFile.Writer.valueClass(CopyListingFileStatus.class),</span><br><span class="line">          SequenceFile.Writer.compression(SequenceFile.CompressionType.NONE));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h3><p>如下为创建任务的源码，和平时创建任务一样，创建Job对象，设置名称，配置输入输出路径，设置Mapper类和Reducer，注意这里只有map任务，设置输入输出类型等等，在这里最终将创建好的job返回给excute()，一层层向上，然后送给调度器。下面关注与文件拷贝相关的几点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Job <span class="title">createJob</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  String jobName = <span class="string">"distcp"</span>;</span><br><span class="line">  String userChosenName = getConf().get(JobContext.JOB_NAME);</span><br><span class="line">  <span class="keyword">if</span> (userChosenName != <span class="keyword">null</span>)</span><br><span class="line">    jobName += <span class="string">": "</span> + userChosenName;</span><br><span class="line">  Job job = Job.getInstance(getConf());</span><br><span class="line">  job.setJobName(jobName);</span><br><span class="line">  job.setInputFormatClass(DistCpUtils.getStrategy(getConf(), inputOptions));</span><br><span class="line">  job.setJarByClass(CopyMapper.class);</span><br><span class="line">  configureOutputFormat(job);</span><br><span class="line"></span><br><span class="line">  job.setMapperClass(CopyMapper.class);</span><br><span class="line">  job.setNumReduceTasks(<span class="number">0</span>);</span><br><span class="line">  job.setMapOutputKeyClass(Text.class);</span><br><span class="line">  job.setMapOutputValueClass(Text.class);</span><br><span class="line">  job.setOutputFormatClass(CopyOutputFormat.class);</span><br><span class="line">  job.getConfiguration().set(JobContext.MAP_SPECULATIVE, <span class="string">"false"</span>);</span><br><span class="line">  job.getConfiguration().set(JobContext.NUM_MAPS,</span><br><span class="line">                String.valueOf(inputOptions.getMaxMaps()));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (inputOptions.getSslConfigurationFile() != <span class="keyword">null</span>) &#123;</span><br><span class="line">    setupSSLConfig(job);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  inputOptions.appendToConf(job.getConfiguration());</span><br><span class="line">  <span class="keyword">return</span> job;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="InputFormat"><a href="#InputFormat" class="headerlink" title="InputFormat"></a>InputFormat</h2><p>在MapReduce中，InputFormat用来描述输入数据的格式，提供以下两个功能：</p>
<ul>
<li>数据切分，按照某个策略将输入数据且分成若干个split，以便确定MapTask的个数即Mapper的个数，在MapReduce框架中，一个split就意味着需要一个Map Task;</li>
<li>为Mapper提供输入数据，即给定一个split，(使用其中的RecordReader对象)将之解析为一个个的key/value键值对。 </li>
</ul>
<p>如下，getSplits用于切分数据，是一种逻辑分片的概念，数据还是按block存储，查看InputSplit源码，InputSplit只记录了Mapper要处理的数据的元数据信息，如起始位置、长度和所在的节点；
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">InputFormat</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> </span><br><span class="line">    <span class="function">List&lt;InputSplit&gt; <span class="title">getSplits</span><span class="params">(JobContext context</span></span></span><br><span class="line"><span class="function"><span class="params">                               )</span> <span class="keyword">throws</span> IOException, InterruptedException</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> </span><br><span class="line">    <span class="function">RecordReader&lt;K,V&gt; <span class="title">createRecordReader</span><span class="params">(InputSplit split,</span></span></span><br><span class="line"><span class="function"><span class="params">                                         TaskAttemptContext context</span></span></span><br><span class="line"><span class="function"><span class="params">                                        )</span> <span class="keyword">throws</span> IOException, </span></span><br><span class="line"><span class="function">                                                 InterruptedException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">InputSplit</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">getLength</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">abstract</span> </span><br><span class="line">    String[] getLocations() <span class="keyword">throws</span> IOException, InterruptedException;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Evolving</span></span><br><span class="line">  <span class="keyword">public</span> SplitLocationInfo[] getLocationInfo() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在DistCp中，有两种输入格式，在上一节创建job代码中可以看到 <code>job.setInputFormatClass(DistCpUtils.getStrategy(getConf(), inputOptions));</code> 是根据配置设置输入格式的。
查看 <code>DistCpConstants</code> 类可以发现 <code>public static final String UNIFORMSIZE = &quot;uniformsize&quot;;</code>, 默认使用的是uniformsize，我们可以通过参数指定使用dynamic模式，两者区别参考<a href="#InputFormats-和-MapReduce-组件">1.3.2小节。</a></p>
<h2 id="CopyMapper"><a href="#CopyMapper" class="headerlink" title="CopyMapper"></a>CopyMapper</h2><p>在创建任务中，通过 <code>job.setMapperClass(CopyMapper.class);</code> 设置了mapper类。CopyMapper<code>是真正的mapper操作，hadoop中的mapper任务就是按照这个逻辑走的。在DistCp中没有reduce，仅有mapper任务，CopyMapper与其他的mapper没有什么区别，也是实现了基类</code>Mapper<code>中的</code>setup()<code>和</code>map()` 两个核心方法。</p>
<ul>
<li>setup: 初始化、参数读取、文件校验等前期工作。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">    conf = context.getConfiguration();</span><br><span class="line"></span><br><span class="line">    syncFolders = conf.getBoolean(DistCpOptionSwitch.SYNC_FOLDERS.getConfigLabel(), <span class="keyword">false</span>);</span><br><span class="line">    ignoreFailures = conf.getBoolean(DistCpOptionSwitch.IGNORE_FAILURES.getConfigLabel(), <span class="keyword">false</span>);</span><br><span class="line">    skipCrc = conf.getBoolean(DistCpOptionSwitch.SKIP_CRC.getConfigLabel(), <span class="keyword">false</span>);</span><br><span class="line">    overWrite = conf.getBoolean(DistCpOptionSwitch.OVERWRITE.getConfigLabel(), <span class="keyword">false</span>);</span><br><span class="line">    append = conf.getBoolean(DistCpOptionSwitch.APPEND.getConfigLabel(), <span class="keyword">false</span>);</span><br><span class="line">    preserve = DistCpUtils.unpackAttributes(conf.get(DistCpOptionSwitch.</span><br><span class="line">        PRESERVE_STATUS.getConfigLabel()));</span><br><span class="line"></span><br><span class="line">    targetWorkPath = <span class="keyword">new</span> Path(conf.get(DistCpConstants.CONF_LABEL_TARGET_WORK_PATH));</span><br><span class="line">    Path targetFinalPath = <span class="keyword">new</span> Path(conf.get(</span><br><span class="line">            DistCpConstants.CONF_LABEL_TARGET_FINAL_PATH));</span><br><span class="line">    targetFS = targetFinalPath.getFileSystem(conf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (targetFS.exists(targetFinalPath) &amp;&amp; targetFS.isFile(targetFinalPath)) &#123;</span><br><span class="line">      overWrite = <span class="keyword">true</span>; <span class="comment">// When target is an existing file, overwrite it.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (conf.get(DistCpConstants.CONF_LABEL_SSL_CONF) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      initializeSSLConf(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>map: 从方法参数可以看出，是对InputFormat分片数据每一行进行处理，其中省略了大部分代码，基本都是针对命令行参数对文件做一些前期校验，是否跳过等。最终如果需要拷贝，会通过 <code>RetriableFileCopyCommand</code> 类使用真正拷贝字节的方法 <code>copyBytes</code>, 就是普通的文件流操作了。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Text relPath, CopyListingFileStatus sourceFileStatus,</span></span></span><br><span class="line"><span class="function"><span class="params">      Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">    copyFileWithRetry(description, sourceCurrStatus, target, context, action, fileAttributes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">copyBytes</span><span class="params">(FileStatus sourceFileStatus, <span class="keyword">long</span> sourceOffset,</span></span></span><br><span class="line"><span class="function"><span class="params">      OutputStream outStream, <span class="keyword">int</span> bufferSize, Mapper.Context context)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Path source = sourceFileStatus.getPath();</span><br><span class="line">    <span class="keyword">byte</span> buf[] = <span class="keyword">new</span> <span class="keyword">byte</span>[bufferSize];</span><br><span class="line">    ThrottledInputStream inStream = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">long</span> totalBytesRead = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      inStream = getInputStream(source, context.getConfiguration());</span><br><span class="line">      <span class="keyword">int</span> bytesRead = readBytes(inStream, buf, sourceOffset);</span><br><span class="line">      <span class="keyword">while</span> (bytesRead &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        totalBytesRead += bytesRead;</span><br><span class="line">        <span class="keyword">if</span> (action == FileAction.APPEND) &#123;</span><br><span class="line">          sourceOffset += bytesRead;</span><br><span class="line">        &#125;</span><br><span class="line">        outStream.write(buf, <span class="number">0</span>, bytesRead);</span><br><span class="line">        updateContextStatus(totalBytesRead, context, sourceFileStatus);</span><br><span class="line">        bytesRead = readBytes(inStream, buf, sourceOffset);</span><br><span class="line">      &#125;</span><br><span class="line">      outStream.close();</span><br><span class="line">      outStream = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      IOUtils.cleanup(LOG, outStream, inStream);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> totalBytesRead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h1 id="命令参数"><a href="#命令参数" class="headerlink" title="命令参数"></a>命令参数</h1><table border="0" style="display: table;border-collapse: separate;border-spacing: 2px;border-color:#ccc;">


<tr class="a">

<td>Flag </td>

<td>Description </td>

<td>Notes</td>
    </tr>


<tr class="b">

<td><tt>-p[rbugpcaxt]</tt> </td>

<td>Preserve r: replication number<br> b: block size<br> u: user<br> g: group<br> p: permission<br> c: checksum-type<br> a: ACL<br> x: XAttr<br> t: timestamp </td>

<td>当指定 <tt>-update</tt>，更新的状态<b>不会同步</b>，除非文件大小不同（例如：重新创建文件）。 如果指定 <tt>-pa</tt>， DistCp 保留文件权限。</td>
    </tr>

<tr class="a">

<td><tt>-i</tt> </td>

<td>忽略失败 </td>

<td>相较默认情况，该选项会提供更精确的拷贝统计，并且保存拷贝失败的日志，方便调试。在没有文成任务中所有分块的尝试之前，一个map的失败不会导致整个任务失败。</td>
    </tr>

<tr class="b">

<td><tt>-log &lt;logdir&gt;</tt> </td>

<td>将日志记录到 &lt;logdir&gt; </td>

<td>DistCp为每个尝试拷贝的操作记录日志并作为map任务的输出。如果一个map失败了，重新执行这个map，日志将不会保留。</td>
    </tr>

<tr class="a">

<td><tt>-v</tt> </td>

<td>SKIP/COPY日志中的附加信息 (path, size) </td>

<td>该选项只能与 <tt>-log</tt> 一起使用.</td>
    </tr>

<tr class="b">

<td><tt>-m &lt;num_maps&gt;</tt> </td>

<td>并行拷贝的最大数量（多少个copy）</td>

<td>指定拷贝数据的map数量。 注意增加map数量并不能够有效提高吞吐量。</td>
    </tr>

<tr class="a">

<td><tt>-overwrite</tt> </td>

<td>覆盖目标文件 </td>

<td>如果map失败了并且没有指定 <tt>-i</tt>, 不仅仅那些失败的文件，这个split中的所有文件将被重新拷贝。 正如使用手册中的说明，这同时会改变生成目标路径的语义(it also changes the semantics for generating destination paths)，用户应该谨慎使用。</td>
    </tr>

<tr class="b">

<td><tt>-update</tt> </td>

<td>如果目标的size(大小), blocksize(块大小), 或 checksum(校验和) 不同，则进行覆盖</td>

<td>这并非“同步”操作，是否执行覆盖的标准是源和目标的文件大小、块大小和校验和是否相同; 如果不同源文件替换目标文件。</td>
    </tr>

<tr class="a">

<td><tt>-append</tt> </td>

<td>同名而不同长度的文件进行增量拷贝 </td>

<td>如果源文件的长度比目标文件大，将会检验共同长度部分的校验和，如果校验和匹配, 使用read和append功能，仅将不同的部分拷贝。<tt>-append</tt> 与 <tt>-update</tt> 并不带 <tt>-skipcrccheck</tt></td>
    </tr>

<tr class="b">

<td><tt>-f &lt;urilist_uri&gt;</tt> </td>

<td>使用 &lt;urilist_uri&gt; 作为源文件列表 </td>

<td>意思就是把每个源文件名列在命令行中。 <tt>urilist_uri</tt> 列表应该是一个完整的、合法的URI。</td>
    </tr>

<tr class="a">

<td><tt>-filters</tt> </td>

<td>The path to a file containing a list of pattern strings, one string per line, such that paths matching the pattern will be excluded from the copy. </td>

<td>Support regular expressions specified by java.util.regex.Pattern.</td>
    </tr>

<tr class="b">

<td><tt>-filelimit &lt;n&gt;</tt> </td>

<td>Limit the total number of files to be &lt;= n </td>

<td><b>Deprecated!</b> Ignored in the new DistCp.</td>
    </tr>

<tr class="a">

<td><tt>-sizelimit &lt;n&gt;</tt> </td>

<td>Limit the total size to be &lt;= n bytes </td>

<td><b>Deprecated!</b> Ignored in the new DistCp.</td>
    </tr>

<tr class="b">

<td><tt>-delete</tt> </td>

<td>Delete the files existing in the dst but not in src </td>

<td>The deletion is done by FS Shell. So the trash will be used, if it is enable. Delete is applicable only with update or overwrite options.</td>
    </tr>

<tr class="a">

<td><tt>-strategy {dynamic|uniformsize}</tt> </td>

<td>选择DistCp的拷贝策略</td>

<td>默认使用uniformsize。 (即，根据拷贝文件的总大小平衡每个map，与传统相仿。) 如果指定 “dynamic”， 将会使用<tt>DynamicInputFormat</tt>。 (详见体系架构)</td>
    </tr>

<tr class="b">

<td><tt>-bandwidth</tt> </td>

<td>给每个map指定带宽, in MB/second. </td>

<td>Each map will be restricted to consume only the specified bandwidth. This is not always exact. The map throttles back its bandwidth consumption during a copy, such that the <b>net</b> bandwidth used tends towards the specified value.</td>
    </tr>

<tr class="a">

<td><tt>-atomic {-tmp &lt;tmp_dir&gt;}</tt> </td>

<td>Specify atomic commit, with optional tmp directory. </td>

<td><tt>-atomic</tt> instructs DistCp to copy the source data to a temporary target location, and then move the temporary target to the final-location atomically. Data will either be available at final target in a complete and consistent form, or not at all. Optionally, <tt>-tmp</tt> may be used to specify the location of the tmp-target. If not specified, a default is chosen. <b>Note:</b> tmp_dir must be on the final target cluster.</td>
    </tr>

<tr class="b">

<td><tt>-mapredSslConf &lt;ssl_conf_file&gt;</tt> </td>

<td>Specify SSL Config file, to be used with HSFTP source </td>

<td>When using the hsftp protocol with a source, the security- related properties may be specified in a config-file and passed to DistCp. &lt;ssl_conf_file&gt; needs to be in the classpath.</td>
    </tr>

<tr class="a">

<td><tt>-async</tt> </td>

<td>异步执行DistCp. Hadoop任务一运行立即返回。 </td>

<td>记录Hadoop任务id， 以便追踪。</td>
    </tr>

<tr class="b">

<td><tt>-diff &lt;oldSnapshot&gt; &lt;newSnapshot&gt;</tt> </td>

<td>Use snapshot diff report between given two snapshots to identify the difference between source and target, and apply the diff to the target to make it in sync with source. </td>

<td>This option is valid only with <tt>-update</tt> option and the following conditions should be satisfied. 
<ol style="list-style-type: decimal">
<li> Both the source and the target FileSystem must be DistributedFileSystem.</li> 
<li> Two snapshots <tt>&lt;oldSnapshot&gt;</tt> and <tt>&lt;newSnapshot&gt;</tt> have been created on the source FS, and <tt>&lt;oldSnapshot&gt;</tt> is older than <tt>&lt;newSnapshot&gt;</tt>. </li> 
<li> The target has the same snapshot <tt>&lt;oldSnapshot&gt;</tt>. No changes have been made on the target since <tt>&lt;oldSnapshot&gt;</tt> was created, thus <tt>&lt;oldSnapshot&gt;</tt> has the same content as the current state of the target. All the files/directories in the target are the same with source’s <tt>&lt;oldSnapshot&gt;</tt>.</li></ol> </td>
    </tr>

<tr class="a">

<td><tt>-rdiff &lt;newSnapshot&gt; &lt;oldSnapshot&gt;</tt> </td>

<td>Use snapshot diff report between given two snapshots to identify what has been changed on the target since the snapshot <tt>&lt;oldSnapshot&gt;</tt> was created on the target, and apply the diff reversely to the target, and copy modified files from the source’s <tt>&lt;oldSnapshot&gt;</tt>, to make the target the same as <tt>&lt;oldSnapshot&gt;</tt>. </td>

<td>This option is valid only with <tt>-update</tt> option and the following conditions should be satisfied. 
<ol style="list-style-type: decimal">
<li>Both the source and the target FileSystem must be DistributedFileSystem. The source and the target can be two different clusters/paths, or they can be exactly the same cluster/path. In the latter case, modified files are copied from target’s <tt>&lt;oldSnapshot&gt;</tt> to target’s current state).</li> 
<li> Two snapshots <tt>&lt;newSnapshot&gt;</tt> and <tt>&lt;oldSnapshot&gt;</tt> have been created on the target FS, and <tt>&lt;oldSnapshot&gt;</tt> is older than <tt>&lt;newSnapshot&gt;</tt>. No change has been made on target since <tt>&lt;newSnapshot&gt;</tt> was created on the target. </li> 
<li> The source has the same snapshot <tt>&lt;oldSnapshot&gt;</tt>, which has the same content as the <tt>&lt;oldSnapshot&gt;</tt> on the target. All the files/directories in the target’s <tt>&lt;oldSnapshot&gt;</tt> are the same with source’s <tt>&lt;oldSnapshot&gt;</tt>.</li> </ol> </td>
    </tr>

<tr class="b">

<td><tt>-numListstatusThreads</tt> </td>

<td>Number of threads to use for building file listing </td>

<td>At most 40 threads.</td>
    </tr>

<tr class="a">

<td><tt>-skipcrccheck</tt> </td>

<td>是否跳过源路径和目标路径之间的 crc 检查。 </td>
    </tr>

<tr class="b">

<td><tt>-blocksperchunk &lt;blocksperchunk&gt;</tt> </td>

<td>每个chunk的块数量，指定后，将文件分割成多个块并行复制。 </td>

<td>If set to a positive value, files with more blocks than this value will be split into chunks of <tt>&lt;blocksperchunk&gt;</tt> blocks to be transferred in parallel, and reassembled on the destination. By default, <tt>&lt;blocksperchunk&gt;</tt> is 0 and the files will be transmitted in their entirety without splitting. This switch is only applicable when the source file system implements getBlockLocations method and the target file system implements concat method. </td>
    </tr>

<tr class="a">

<td><tt>-copybuffersize &lt;copybuffersize&gt;</tt> </td>

<p><td>Size of the copy buffer to use. By default, <tt>&lt;copybuffersize&gt;</tt> is set to 8192B </td>
    </p></tr><p></p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2></table>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/05/redis/rdsmq/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yampery">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天尽头，回眸望红尘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/05/redis/rdsmq/" itemprop="url">基于Redis的消息队列</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-05T14:47:07+08:00">
                2019-01-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2019/01/05/redis/rdsmq/" class="leancloud_visitors" data-flag-title="基于Redis的消息队列">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文以redis为数据结构基础，配合Spring管理机制，使用java实现了一个轻量级、可配置的消息队列。适合的项目特点：</p>
<ul>
<li><strong>Spring框架管理对象</strong></li>
<li><strong>有消息需求，但不想维护mq中间件</strong></li>
<li><strong>有使用redis</strong></li>
<li><strong>对消息持久化并没有很苛刻的要求</strong></li>
</ul>
<p><em><a href="http://blog.csdn.net/wizard_rp/article/details/79310206" target="_blank" rel="noopener">需要使用rabbitmq实现延迟消息请参考这里</a></em></p>
<hr>
<h1 id="设计方案"><a href="#设计方案" class="headerlink" title="设计方案"></a>设计方案</h1><p><strong>设计主要包含以下几点：</strong></p>
<ul>
<li>将整个Redis当做消息池，以kv形式存储消息</li>
<li>使用ZSET做优先队列，按照score维持优先级</li>
<li>使用LIST结构，以先进先出的方式消费</li>
<li>zset和list存储消息地址（对应消息池的每个key）</li>
<li>自定义路由对象，存储zset和list名称，以点对点的方式将消息从zset路由到正确的list</li>
<li>使用定时器维持路由</li>
<li>根据TTL规则实现消息延迟</li>
</ul>
<p> <img src="http://img.blog.csdn.net/20180209131159151?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvd2l6YXJkX3Jw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="基于Redis有消息队列设计方案"></p>
<h1 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h1><h2 id="技术说明"><a href="#技术说明" class="headerlink" title="技术说明"></a>技术说明</h2><blockquote>
<p>示例使用Springboot，gradle，redis，jdk8。</p>
</blockquote>
<h2 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h2><blockquote>
<p>核心代码主要包含消息对象Message，路由器Route和消息队列RedisMQ。</p>
</blockquote>
<h3 id="Message对象"><a href="#Message对象" class="headerlink" title="Message对象"></a>Message对象</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> git.yampery.msmq;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@decription</span> Message</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;封装消息元数据&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Yampery</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/11/2 15:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息主题</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String topic;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息延迟</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> delay;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息优先级</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> priority;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息存活时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> ttl;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息体，对应业务内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String body;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间，如果只有优先级没有延迟，可以设置创建时间为0</span></span><br><span class="line"><span class="comment">     * 用来消除时间的影响</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> createTime;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息状态（延迟-0；待发送-1；已发送-2；发送失败-3）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * getset略...</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Route-消息路由器"><a href="#Route-消息路由器" class="headerlink" title="Route(消息路由器)"></a>Route(消息路由器)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> git.yampery.msmq;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@decription</span> Route</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;消息路由器，主要控制将消息从指定的队列路由到待消费的list&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * 通过这种方式实现自定义延迟以及优先级发送&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Yampery</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/11/3 14:33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Route</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存放消息的队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String queue;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 待消费的列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String list;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Route</span><span class="params">(String queue, String list)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.queue = queue;</span><br><span class="line">        <span class="keyword">this</span>.list = list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * getset略...</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="RedisMq-消息队列"><a href="#RedisMq-消息队列" class="headerlink" title="RedisMq(消息队列)"></a>RedisMq(消息队列)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> git.yampery.msmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> git.yampery.utils.JedisUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@decription</span> RedisMQ</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;基于redis的消息队列&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;将整个redis作为消息池存储消息体，以ZSET为消息队列，LIST作为待消费列表&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * 用Spring定时器作为监听器，每次监听ZSET中指定数量的消息&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * 根据SCORE确定是否达到发送要求，如果达到，利用消息路由&#123;<span class="doctag">@link</span> Route&#125;将消息路由到待消费list&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Yampery</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/11/2 15:49</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisMQ</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息池前缀，以此前缀加上传递的消息id作为key，以消息&#123;<span class="doctag">@link</span> Message&#125;</span></span><br><span class="line"><span class="comment">     * 的消息体body作为值存储</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MSG_POOL = <span class="string">"Message:Pool:"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认监听数量，对应监听zset队列前多少个元素</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAUT_MONITOR = <span class="number">10</span>;</span><br><span class="line">    <span class="meta">@Resource</span> <span class="keyword">private</span> JedisUtils jedisUtils;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每次监听queue中元素的数量，可配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> monitorCount = DEFAUT_MONITOR;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息路由</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Route&gt; routes;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存入消息池</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addMsgPool</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != message) &#123;</span><br><span class="line">            <span class="keyword">return</span> jedisUtils.setex(MSG_POOL + message.getId(), message.getBody(), message.getTtl());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从消息池中删除消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deMsgPool</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> jedisUtils.del(MSG_POOL + id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 像队列中添加消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> score 优先级</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> val</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回消息id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">enMessage</span><span class="params">(String key, <span class="keyword">long</span> score, String val)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (jedisUtils.zadd(key, score, val)) &#123;</span><br><span class="line">            <span class="keyword">return</span> val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从队列删除消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deMessage</span><span class="params">(String key, String id)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> jedisUtils.zdel(key, id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消费</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">consume</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> count = jedisUtils.countList(key);</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> &lt; count) &#123;</span><br><span class="line">            <span class="comment">// 可根据需求做限制</span></span><br><span class="line">            List&lt;String&gt; ids = jedisUtils.rangeList(key, <span class="number">0</span>, count - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (ids != <span class="keyword">null</span>) &#123;</span><br><span class="line">                List&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                ids.forEach(l -&gt; result.add(jedisUtils.get(MSG_POOL + l, <span class="string">""</span>)));</span><br><span class="line">                jedisUtils.removeListValue(key, ids);</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125; <span class="comment">/// if end~</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息队列监听器&lt;br&gt;</span></span><br><span class="line"><span class="comment">     * 监听所有路由器，将消息队列中的消息路由到待消费列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled</span>(cron=<span class="string">"*/5 * * * * *"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">monitor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取消息路由</span></span><br><span class="line">        <span class="keyword">int</span> route_size;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == routes || <span class="number">1</span> &gt; (route_size = routes.size())) <span class="keyword">return</span>;</span><br><span class="line">        String queue, list;</span><br><span class="line">        Set&lt;String&gt; set;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; route_size; i++) &#123;</span><br><span class="line">            queue = routes.get(i).getQueue();</span><br><span class="line">            list = routes.get(i).getList();</span><br><span class="line">            set = jedisUtils.getSoredSetByRange(queue, <span class="number">0</span>, monitorCount, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != set) &#123;</span><br><span class="line">                <span class="keyword">long</span> current = System.currentTimeMillis();</span><br><span class="line">                <span class="keyword">long</span> score;</span><br><span class="line">                <span class="keyword">for</span> (String id : set) &#123;</span><br><span class="line">                     score = jedisUtils.getScore(queue, id).longValue();</span><br><span class="line">                    <span class="keyword">if</span> (current &gt;= score) &#123;</span><br><span class="line">                        <span class="comment">// 添加到list</span></span><br><span class="line">                        <span class="keyword">if</span> (jedisUtils.insertList(list, id)) &#123;</span><br><span class="line">                            <span class="comment">// 删除queue中的元素</span></span><br><span class="line">                            deMessage(queue, id);</span><br><span class="line">                        &#125; <span class="comment">/// if end~</span></span><br><span class="line">                    &#125; <span class="comment">/// if end~</span></span><br><span class="line">                &#125; <span class="comment">/// for end~</span></span><br><span class="line">            &#125; <span class="comment">/// if end~</span></span><br><span class="line">        &#125; <span class="comment">/// for end~</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMonitorCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> monitorCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMonitorCount</span><span class="params">(<span class="keyword">int</span> monitorCount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.monitorCount = monitorCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Route&gt; <span class="title">getRoutes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> routes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRoutes</span><span class="params">(List&lt;Route&gt; routes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.routes = routes;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="RedisMq消息队列配置："><a href="#RedisMq消息队列配置：" class="headerlink" title="RedisMq消息队列配置："></a>RedisMq消息队列配置：</h3><ul>
<li>mq.properties文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 队列的监听数量</span><br><span class="line">mq.monitor.count                 =30</span><br><span class="line"># 队列一</span><br><span class="line">mq.queue.first                  =queue:1</span><br><span class="line"># 队列二</span><br><span class="line">mq.queue.second                 =queue:2</span><br><span class="line"># 消费列表一</span><br><span class="line">mq.consumer.first               =list:1</span><br><span class="line"># 消费列表二</span><br><span class="line">mq.consumer.second              =list:2</span><br></pre></td></tr></table></figure>
<ul>
<li>MqConfig.java文件</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> git.yampery.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> git.yampery.msmq.RedisMQ;</span><br><span class="line"><span class="keyword">import</span> git.yampery.msmq.Route;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@decription</span> MqConfig</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;消息队列配置&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Yampery</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/2/9 14:26</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 根据不同的架构可选择使用XML配置</span></span><br><span class="line"><span class="comment"> * ---------------------------------------------------</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment">    &lt;bean id="redisMQ" class="git.yampery.msmq.RedisMQ"&gt;</span></span><br><span class="line"><span class="comment">        &lt;property name="monitorCount" value="15"/&gt;</span></span><br><span class="line"><span class="comment">        &lt;property name="routes"&gt;</span></span><br><span class="line"><span class="comment">            &lt;list&gt;</span></span><br><span class="line"><span class="comment">                &lt;bean class="git.yampery.msmq.Route"&gt;</span></span><br><span class="line"><span class="comment">                    &lt;property name="queue" value="$&#123;mq.queue.first&#125;"/&gt;</span></span><br><span class="line"><span class="comment">                    &lt;property name="list" value="$&#123;mq.consumer.first&#125;"/&gt;</span></span><br><span class="line"><span class="comment">                &lt;/bean&gt;</span></span><br><span class="line"><span class="comment">                &lt;bean class="git.yampery.msmq.Route"&gt;</span></span><br><span class="line"><span class="comment">                    &lt;property name="queue" value="$&#123;mq.queue.second&#125;"/&gt;</span></span><br><span class="line"><span class="comment">                    &lt;property name="list" value="$&#123;mq.consumer.second&#125;"/&gt;</span></span><br><span class="line"><span class="comment">                &lt;/bean&gt;</span></span><br><span class="line"><span class="comment">            &lt;/list&gt;</span></span><br><span class="line"><span class="comment">        &lt;/property&gt;</span></span><br><span class="line"><span class="comment">    &lt;/bean&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> * ----------------------------------------------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MqConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"redisMQ"</span>)</span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisMQ <span class="title">getRedisMq</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RedisMQ redisMQ = <span class="keyword">new</span> RedisMQ();</span><br><span class="line">        <span class="comment">// 配置监听队列元素数量</span></span><br><span class="line">        redisMQ.setMonitorCount(monitorCount);</span><br><span class="line">        <span class="comment">// 配置路由表</span></span><br><span class="line">        redisMQ.setRoutes(routeList());</span><br><span class="line">        <span class="keyword">return</span> redisMQ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回路由表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Route&gt; <span class="title">routeList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;Route&gt; routeList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Route routeFirst = <span class="keyword">new</span> Route(queueFirst, listFirst);</span><br><span class="line">        Route routeSecond = <span class="keyword">new</span> Route(queueSecond, listSecond);</span><br><span class="line">        routeList.add(routeFirst);</span><br><span class="line">        routeList.add(routeSecond);</span><br><span class="line">        <span class="keyword">return</span> routeList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mq.monitor.count&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> monitorCount;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mq.queue.first&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String queueFirst;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mq.queue.second&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String queueSecond;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mq.consumer.first&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String listFirst;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mq.consumer.second&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String listSecond;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>如果使用的是xml配置</strong>　请参考：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"redisMQ"</span> <span class="attr">class</span>=<span class="string">"git.yampery.msmq.RedisMQ"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"monitorCount"</span> <span class="attr">value</span>=<span class="string">"15"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"routes"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"git.yampery.msmq.Route"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"queue"</span> <span class="attr">value</span>=<span class="string">"$&#123;mq.queue.first&#125;"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"list"</span> <span class="attr">value</span>=<span class="string">"$&#123;mq.consumer.first&#125;"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"git.yampery.msmq.Route"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"queue"</span> <span class="attr">value</span>=<span class="string">"$&#123;mq.queue.second&#125;"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"list"</span> <span class="attr">value</span>=<span class="string">"$&#123;mq.consumer.second&#125;"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h3><blockquote>
<p>并没有内置消费者监听器来实现，可以直接使用定时器实现</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> git.yampery.task;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> git.yampery.msmq.RedisMQ;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@decription</span> MsgTask</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;发送消息&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Yampery</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/2/9 18:04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MsgTask</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span> <span class="keyword">private</span> RedisMQ redisMQ;</span><br><span class="line">    <span class="comment">// @Value("$&#123;mq.list.first&#125;") private String MQ_LIST_FIRST;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled</span>(cron=<span class="string">"*/5 * * * * *"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 消费</span></span><br><span class="line">        List&lt;String&gt; msgs = redisMQ.consume(redisMQ.getRoutes().get(<span class="number">0</span>).getList());</span><br><span class="line">        <span class="keyword">int</span> len;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != msgs &amp;&amp; <span class="number">0</span> &lt; (len = msgs.size())) &#123;</span><br><span class="line">            <span class="comment">// 将每一条消息转为JSONObject</span></span><br><span class="line">            JSONObject jObj;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!StringUtils.isEmpty(msgs.get(i))) &#123;</span><br><span class="line">                    jObj = JSONObject.parseObject(msgs.get(i));</span><br><span class="line">                    <span class="comment">// 取出消息</span></span><br><span class="line">                    System.out.println(jObj.toJSONString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><blockquote>
<p>测试设置20秒延迟，发布消息到queue:1，在list:1消费。
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> git.yampery.mq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> git.yampery.msmq.Message;</span><br><span class="line"><span class="keyword">import</span> git.yampery.msmq.RedisMQ;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@decription</span> TestMQ</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;测试&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Yampery</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/2/9 18:43</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestMQ</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisMQ redisMQ;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;mq.queue.first&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String MQ_QUEUE_FIRST;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMq</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        JSONObject jObj = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        jObj.put(<span class="string">"msg"</span>, <span class="string">"这是一条短信"</span>);</span><br><span class="line"></span><br><span class="line">        String seqId = UUID.randomUUID().toString();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将有效信息放入消息队列和消息池中</span></span><br><span class="line">        Message message = <span class="keyword">new</span> Message();</span><br><span class="line">        message.setBody(jObj.toJSONString());</span><br><span class="line">        <span class="comment">// 可以添加延迟配置</span></span><br><span class="line">        message.setDelay(<span class="number">20</span>);</span><br><span class="line">        message.setTopic(<span class="string">"SMS"</span>);</span><br><span class="line">        message.setCreateTime(System.currentTimeMillis());</span><br><span class="line">        message.setId(seqId);</span><br><span class="line">        <span class="comment">// 设置消息池ttl，防止长期占用</span></span><br><span class="line">        message.setTtl(<span class="number">20</span> * <span class="number">60</span>);</span><br><span class="line">        message.setStatus(<span class="number">0</span>);</span><br><span class="line">        message.setPriority(<span class="number">0</span>);</span><br><span class="line">        redisMQ.addMsgPool(message);</span><br><span class="line">        redisMQ.enMessage(MQ_QUEUE_FIRST,</span><br><span class="line">                message.getCreateTime() + message.getDelay() + message.getPriority(), message.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>文章利用redis已有的数据存储结构，实现了轻量级的消息队列，并未真正实现消息持久化。示例是针对点对点的消息路由方式，当然，也可以扩展成广播和主题的方式，不过，这样就得不偿失了，如果需求比较复杂，可靠性要求较高，反而不如直接维护rabbitmq之类的消息队列。 
<em><a href="http://blog.csdn.net/wizard_rp/article/details/79310206" target="_blank" rel="noopener">需要使用rabbitmq实现延迟消息请参考这里</a></em></p>
<h1 id="源码连接"><a href="#源码连接" class="headerlink" title="源码连接"></a>源码连接</h1><blockquote>
<p>文章并未贴出所有代码，gradle构建、jedisUtils以及一些配置等可以参考源码，源码只需要设置自己的redis配置即可。
<a href="https://github.com/Yampery/rdsmq.git" target="_blank" rel="noopener">https://github.com/Yampery/rdsmq.git</a></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/05/ykt_test_binding/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yampery">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天尽头，回眸望红尘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/05/ykt_test_binding/" itemprop="url">性能测试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-05T14:47:07+08:00">
                2019-01-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2019/01/05/ykt_test_binding/" class="leancloud_visitors" data-flag-title="性能测试">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="性能测试"><a href="#性能测试" class="headerlink" title="性能测试"></a>性能测试</h1><hr>
<h2 id="测试目标"><a href="#测试目标" class="headerlink" title="测试目标"></a>测试目标</h2><pre><code>1. 绑定接口性能：响应时长，并发量
2. 历史表500w数据下事务的处理情况
3. 压测过程线程状态
4. 压测过程堆状态
</code></pre><h2 id="当前状态"><a href="#当前状态" class="headerlink" title="当前状态"></a>当前状态</h2><pre><code>1. 号池总量：1000000
2. T_REGINFO总量：20006
3. T_REGINFOHIS总量：4884369
</code></pre><h2 id="测试服务器"><a href="#测试服务器" class="headerlink" title="测试服务器"></a>测试服务器</h2><h3 id="系统版本"><a href="#系统版本" class="headerlink" title="系统版本"></a>系统版本</h3><pre><code>Linux testserver-centos 3.10.0-693.21.1.el7.x86_64 #1 SMP Wed Mar 7 19:03:37 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
</code></pre><h3 id="CPU信息"><a href="#CPU信息" class="headerlink" title="CPU信息"></a>CPU信息</h3><pre><code>Intel(R) Xeon(R) CPU E5-2650 0 @ 2.00GHz    X32
</code></pre><h3 id="内存信息"><a href="#内存信息" class="headerlink" title="内存信息"></a>内存信息</h3><pre><code>MemTotal:       16215504 kB
MemFree:         5705052 kB
MemAvailable:   10554240 kB
Buffers:              28 kB
Cached:          5565036 kB
SwapCached:       518972 kB
Active:          5504676 kB
Inactive:        4168584 kB
Active(anon):    2818640 kB
Inactive(anon):  2020616 kB
Active(file):    2686036 kB
Inactive(file):  2147968 kB
Unevictable:           0 kB
Mlocked:               0 kB
SwapTotal:       8126460 kB
SwapFree:        6607556 kB
Dirty:                84 kB
Writeback:             0 kB
AnonPages:       3626044 kB
Mapped:           218624 kB
Shmem:            731060 kB
Slab:             564724 kB
SReclaimable:     410288 kB
SUnreclaim:       154436 kB
KernelStack:       12608 kB
PageTables:        77320 kB
NFS_Unstable:          0 kB
Bounce:                0 kB
WritebackTmp:          0 kB
CommitLimit:    16234212 kB
Committed_AS:    7857184 kB
VmallocTotal:   34359738367 kB
VmallocUsed:      316296 kB
VmallocChunk:   34350563324 kB
HardwareCorrupted:     0 kB
AnonHugePages:    110592 kB
HugePages_Total:       0
HugePages_Free:        0
HugePages_Rsvd:        0
HugePages_Surp:        0
Hugepagesize:       2048 kB
DirectMap4k:      363456 kB
DirectMap2M:    14270464 kB
DirectMap1G:     2097152 kB
</code></pre><h2 id="数据服务器"><a href="#数据服务器" class="headerlink" title="数据服务器"></a>数据服务器</h2><h3 id="系统版本-1"><a href="#系统版本-1" class="headerlink" title="系统版本"></a>系统版本</h3><pre><code>Linux weihua2 2.6.32-573.18.1.el6.i686 #1 SMP Tue Feb 9 19:51:22 UTC 2016 i686 i686 i386 GNU/Linux
</code></pre><h3 id="CPU信息-1"><a href="#CPU信息-1" class="headerlink" title="CPU信息"></a>CPU信息</h3><pre><code>Intel(R) Xeon(R) CPU E5-2650 0 @ 2.00GHz     X32
</code></pre><h3 id="内存信息-1"><a href="#内存信息-1" class="headerlink" title="内存信息"></a>内存信息</h3><pre><code>MemTotal:        8130136 kB
MemFree:         2471888 kB
Buffers:          347776 kB
Cached:           604844 kB
SwapCached:        28720 kB
Active:          4093188 kB
Inactive:        1380972 kB
Active(anon):    3596772 kB
Inactive(anon):   926380 kB
Active(file):     496416 kB
Inactive(file):   454592 kB
Unevictable:           0 kB
Mlocked:               0 kB
HighTotal:       7435208 kB
HighFree:        2288728 kB
LowTotal:         694928 kB
LowFree:          183160 kB
SwapTotal:       8273916 kB
SwapFree:        8214956 kB
Dirty:                28 kB
Writeback:             0 kB
AnonPages:       4493096 kB
Mapped:            33680 kB
Shmem:              1540 kB
Slab:             102100 kB
SReclaimable:      78500 kB
SUnreclaim:        23600 kB
KernelStack:        7672 kB
PageTables:        14536 kB
NFS_Unstable:          0 kB
Bounce:                0 kB
WritebackTmp:          0 kB
CommitLimit:    12338984 kB
Committed_AS:    5936384 kB
VmallocTotal:     122880 kB
VmallocUsed:        7400 kB
VmallocChunk:      35868 kB
HugePages_Total:       0
HugePages_Free:        0
HugePages_Rsvd:        0
HugePages_Surp:        0
Hugepagesize:       2048 kB
DirectMap4k:       10232 kB
DirectMap2M:      897024 kB
</code></pre><h2 id="负载机"><a href="#负载机" class="headerlink" title="负载机"></a>负载机</h2><h3 id="系统版本-2"><a href="#系统版本-2" class="headerlink" title="系统版本"></a>系统版本</h3><pre><code>Linux weihua1 2.6.32-279.el6.i686 #1 SMP Fri Jun 22 10:59:55 UTC 2012 i686 i686 i386 GNU/Linux
</code></pre><h3 id="cpu信息"><a href="#cpu信息" class="headerlink" title="cpu信息"></a>cpu信息</h3><pre><code>Intel(R) Xeon(R) CPU E5-2650 0 @ 2.00GHz  X32
</code></pre><h3 id="内存信息-2"><a href="#内存信息-2" class="headerlink" title="内存信息"></a>内存信息</h3><pre><code>MemTotal:        8130520 kB
MemFree:         5369356 kB
Buffers:          256976 kB
Cached:          2222852 kB
SwapCached:         7724 kB
Active:          1667240 kB
Inactive:         853124 kB
Active(anon):      15696 kB
Inactive(anon):    26080 kB
Active(file):    1651544 kB
Inactive(file):   827044 kB
Unevictable:           0 kB
Mlocked:               0 kB
HighTotal:       7435208 kB
HighFree:        5249168 kB
LowTotal:         695312 kB
LowFree:          120188 kB
SwapTotal:       8273912 kB
SwapFree:        8201640 kB
Dirty:              4080 kB
Writeback:             0 kB
AnonPages:         33944 kB
Mapped:            14192 kB
Shmem:              1240 kB
Slab:             150052 kB
SReclaimable:     130256 kB
SUnreclaim:        19796 kB
KernelStack:        6600 kB
PageTables:         5184 kB
NFS_Unstable:          0 kB
Bounce:                0 kB
WritebackTmp:          0 kB
CommitLimit:    12339172 kB
Committed_AS:     588200 kB
VmallocTotal:     122880 kB
VmallocUsed:        7064 kB
VmallocChunk:      84064 kB
HugePages_Total:       0
HugePages_Free:        0
HugePages_Rsvd:        0
HugePages_Surp:        0
Hugepagesize:       2048 kB
DirectMap4k:       10232 kB
DirectMap2M:      897024 kB
</code></pre><h2 id="测试准备"><a href="#测试准备" class="headerlink" title="测试准备"></a>测试准备</h2><pre><code>1. 测试工具：jmeter 4.0；
2. 测试数据：csv 100w；
3. 线程组：500并发，60秒增长时间，600秒持续时间。
</code></pre><h2 id="测试结果一"><a href="#测试结果一" class="headerlink" title="测试结果一"></a>测试结果一</h2><pre><code>未开启TIME_WAIT重用，FIN_WAIT_2状态时间为60
</code></pre><h3 id="聚合分析"><a href="#聚合分析" class="headerlink" title="聚合分析"></a>聚合分析</h3><p><img src="https://i.imgur.com/dS29AV5.png" alt="">
<img src="https://i.imgur.com/eJTZ9u2.png" alt=""></p>
<h3 id="响应时长"><a href="#响应时长" class="headerlink" title="响应时长"></a>响应时长</h3><p><img src="https://i.imgur.com/2k9DUsY.png" alt=""></p>
<h2 id="测试结果二"><a href="#测试结果二" class="headerlink" title="测试结果二"></a>测试结果二</h2><pre><code>开启TIME_WAIT重用，FIN_WAIT_2状态时间为30
</code></pre><h3 id="聚合分析-1"><a href="#聚合分析-1" class="headerlink" title="聚合分析"></a>聚合分析</h3><p><img src="https://i.imgur.com/29x2Idw.png" alt="">
<img src="https://i.imgur.com/4vLS2uA.png" alt=""></p>
<h3 id="响应时长-1"><a href="#响应时长-1" class="headerlink" title="响应时长"></a>响应时长</h3><p><img src="https://i.imgur.com/ZMkoGuB.png" alt=""></p>
<h1 id="数据库访问情况"><a href="#数据库访问情况" class="headerlink" title="数据库访问情况"></a>数据库访问情况</h1><hr>
<h3 id="T-REGINFOHIS表"><a href="#T-REGINFOHIS表" class="headerlink" title="T_REGINFOHIS表"></a>T_REGINFOHIS表</h3><ul>
<li>数据量：4884369</li>
<li><p>表结构</p>
<pre><code>CREATE TABLE `T_REGINFOHIS` (
  `hisid` bigint(16) NOT NULL AUTO_INCREMENT,
  `addtime` datetime DEFAULT NULL,
  `opuidtype` char(1) DEFAULT NULL,
  `uidnumber` varchar(16) DEFAULT NULL,
  `regphone` varchar(32) DEFAULT NULL,
  `subid` bigint(16) DEFAULT NULL,
  `regtime` datetime NOT NULL DEFAULT &apos;0000-00-00 00:00:00&apos;,
  `regmodule` varchar(16) DEFAULT NULL,
  `uidtype` varchar(8) DEFAULT NULL,
  `callrestrict` varchar(8) DEFAULT NULL,
  `callrecording` varchar(4) DEFAULT NULL,
  `anucode` varchar(64) DEFAULT NULL,
  `bnucode` varchar(64) DEFAULT NULL COMMENT &apos;被叫放音&apos;,
  `calldisplay` varchar(16) DEFAULT NULL,
  `productid` int(11) DEFAULT NULL,
  `name` varchar(32) DEFAULT NULL,
  `cardtype` varchar(32) DEFAULT NULL,
  `cardno` varchar(32) DEFAULT NULL,
  `calldisplaynouid` varchar(32) DEFAULT NULL,
  `unitid` varchar(64) DEFAULT NULL,
  `expiretime` datetime DEFAULT NULL,
  `logid` bigint(10) DEFAULT NULL,
  `uuidinpartner` varchar(64) DEFAULT NULL,
  `batchworkid` varchar(36) DEFAULT NULL,
  `opuser` varchar(64) DEFAULT NULL,
  PRIMARY KEY (`hisid`,`regtime`),
  KEY `ind_uidnumber` (`uidnumber`),
  KEY `ind_regphone` (`regphone`),
  KEY `ind_uuidinpartner` (`uuidinpartner`)
) ENGINE=InnoDB AUTO_INCREMENT=5884370 DEFAULT CHARSET=utf8
</code></pre></li>
</ul>
<h3 id="T-REGINFO表"><a href="#T-REGINFO表" class="headerlink" title="T_REGINFO表"></a>T_REGINFO表</h3><ul>
<li>数据量：20006</li>
<li><p>表结构</p>
<pre><code>CREATE TABLE `T_REGINFO` (
  `uidnumber` varchar(16) DEFAULT NULL,
  `regphone` varchar(32) DEFAULT NULL,
  `subid` bigint(16) NOT NULL AUTO_INCREMENT,
  `regtime` datetime DEFAULT NULL,
  `regmodule` varchar(16) DEFAULT NULL,
  `uidtype` varchar(8) DEFAULT NULL,
  `callrestrict` varchar(8) DEFAULT NULL,
  `callrecording` varchar(4) DEFAULT NULL,
  `anucode` varchar(64) DEFAULT NULL,
  `bnucode` varchar(64) DEFAULT NULL COMMENT &apos;被叫放音&apos;,
  `calldisplay` varchar(16) DEFAULT NULL,
  `productid` int(11) DEFAULT NULL,
  `name` varchar(32) DEFAULT NULL,
  `cardtype` varchar(32) DEFAULT NULL,
  `cardno` varchar(32) DEFAULT NULL,
  `calldisplaynouid` varchar(16) DEFAULT NULL,
  `unitid` varchar(16) DEFAULT NULL,
  `expiretime` datetime DEFAULT NULL,
  `uuidinpartner` varchar(64) DEFAULT NULL,
  `batchworkid` varchar(36) DEFAULT &apos;&apos;,
  `opuser` varchar(64) DEFAULT NULL,
  PRIMARY KEY (`subid`),
  KEY `ind_reginfo_batchworkid` (`batchworkid`) USING BTREE,
  KEY `ind_reginfo_uuidinpartner` (`uuidinpartner`) USING BTREE,
  KEY `ind_reginfo_uidnumber` (`uidnumber`),
  KEY `ind_reginfo_regphone` (`regphone`)
) ENGINE=InnoDB AUTO_INCREMENT=3452188 DEFAULT CHARSET=utf8;
</code></pre></li>
</ul>
<hr>
<h3 id="sql语句"><a href="#sql语句" class="headerlink" title="sql语句"></a>sql语句</h3><ul>
<li><p>写入T_REGINFOHIS</p>
<pre><code>INSERT INTO T_REGINFOHIS (hisid, addtime, opuidtype, uidnumber, regphone
, subid, regtime, regmodule, uidtype, callrestrict
, callrecording, anucode, bnucode, calldisplay, productid
, name, cardtype, cardno, calldisplaynouid, unitid
, expiretime, logid, uuidinpartner, batchworkid, opuser)
VALUES (?, now(), ?, ?, ?
, ?, ?, ?, ?, ?
, ?, ?, ?, ?, ?
, ?, ?, ?, ?, ?
, ?, ?, ?, ?, ?)
</code></pre></li>
<li><p>写入T_REGINFO</p>
<pre><code>INSERT INTO T_REGINFO (subid, uidnumber, regphone, regtime, regmodule
, uidtype, callrestrict, callrecording, anucode, bnucode
, calldisplay, productid, name, cardtype, cardno
, calldisplaynouid, unitid, expiretime, uuidinpartner, batchworkid
, opuser)
VALUES (?, ?, ?, ?, ?
, ?, ?, ?, ?, ?
, ?, ?, ?, ?, ?
, ?, ?, ?, ?, ?
, ?)
</code></pre></li>
</ul>
<hr>
<h3 id="sql统计结果"><a href="#sql统计结果" class="headerlink" title="sql统计结果"></a>sql统计结果</h3><table style="table-layout:auto">
    <tr>
        <td>用例</td>
        <td>执行数</td>
        <td>执行时间</td>
        <td>最慢</td>
        <td>时间分布</td>
        <td>平均时间</td>
    </tr>
    <tr>
        <td>写入T_REGINFOHIS</td>
        <td>1,000,000</td>
        <td>33,850,801</td>
        <td>8,945</td>
        <td>[310988,441162,157808,86465,3577,0,0,0]</td>
        <td>33.9</td>
    </tr>
    <tr>
        <td>写入T_REGINFO</td>
        <td>1,000,000</td>
        <td>37,210,288</td>
        <td>8,906</td>
        <td>[403461,337974,188582,64237,5746,0,0,0]</td>
        <td>37.2</td>
    </tr>
</table>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/05/docker_elk/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yampery">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天尽头，回眸望红尘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/05/docker_elk/" itemprop="url">基于docker搭建ELK系统</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-05T14:47:07+08:00">
                2019-01-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2019/01/05/docker_elk/" class="leancloud_visitors" data-flag-title="基于docker搭建ELK系统">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="基础镜像-elkbase-v1-0"><a href="#基础镜像-elkbase-v1-0" class="headerlink" title="基础镜像 elkbase:v1.0"></a>基础镜像 elkbase:v1.0</h2><ul>
<li>准备jdk 放在tools文件夹下</li>
<li><p>准备Dockerfile</p>
<pre><code>FROM centos:latest
MAINTAINER Yampery&lt;yampery@163.com&gt;
VOLUME [ &quot;/opt/product/data/&quot; ]
RUN  /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
RUN /bin/echo -e &quot;ZONE=&quot;Asia/Shanghai&quot;\nUTC=false\nRTC=false&quot; &gt; /etc/sysconfig/clock
RUN mkdir /opt/product/tools/
ADD ./tools /opt/product/tools/
ENV JAVA_HOME /opt/product/tools/jdk-9.0.1
CMD [&quot;/usr/sbin/init&quot;]
</code></pre></li>
<li><p>构建文件结构</p>
<pre><code>|-elk
    |-tools
        |-jdk-9.0.1
    |--Dockerfile
</code></pre></li>
<li><p>构建镜像</p>
<pre><code>elk/elkbase$ docker build -t elkbase:v1.0 . 
</code></pre></li>
</ul>
<h2 id="elasticsearch-v1-0"><a href="#elasticsearch-v1-0" class="headerlink" title="elasticsearch:v1.0"></a>elasticsearch:v1.0</h2><ul>
<li><p>准备elasticsearch</p>
<pre><code>https://www.elastic.co/downloads/elasticsearch
</code></pre></li>
<li><p>准备Dockerfile</p>
<pre><code>FROM elkbase:v1.0
MAINTAINER Yampery&lt;yampery@163.com&gt;
VOLUME [ &quot;/opt/product/data/&quot; ]
ADD ./tools /opt/product/
RUN useradd elk &amp;&amp; chown -R elk:elk /opt/product/elasticsearch-6.0.0
ADD build.sh /root/
RUN chmod +x /root/build.sh
EXPOSE 9200
EXPOSE 9300
ENTRYPOINT [&quot;/root/build.sh&quot;]
CMD [&quot;/usr/sbin/init&quot;]
</code></pre></li>
<li><p>准备脚本build.sh</p>
<pre><code>#!/bin/bash
echo &quot;* soft nofile 65536&quot; &gt; /etc/security/limits.conf 
echo &quot;* hard nofile 131072&quot; &gt; /etc/security/limits.conf
echo &quot;* soft nproc 2048&quot; &gt; /etc/security/limits.conf
echo &quot;* hard nproc 4096&quot; &gt; /etc/security/limits.conf
echo &quot;vm.max_map_count=655360&quot; &gt; /etc/sysctl.conf 
sysctl -p
cd /opt/product/elasticsearch-6.0.0/config/
rm -rf elasticsearch.yml
cp /opt/product/data/elk/elasticsearch.yml .
chown -R elk:elk /opt/product/elasticsearch-6.0.0
chown -R elk:elk /opt/product/data/elk/elasticsearchdata
su - elk &lt;&lt;!
export JAVA_HOME=/opt/product/tools/jdk-9.0.1
export PATH=$JAVA_HOME/bin:$PATH 
/opt/product/elasticsearch-6.0.0/bin/elasticsearch
</code></pre></li>
<li><p>构建目录结构</p>
<pre><code>|-elk
    |-elasticsearch
        |-tools
        |--Dockerfile
        |--build.sh
</code></pre></li>
<li><p>构建镜像</p>
<pre><code>elk/elasticsearch$ docker build -f elasticsearch:v1.0 .
</code></pre></li>
<li><p>配置</p>
<pre><code>在/opt/product/data目录下建立elk目录，并拷贝elasticsearch.yml文件到该目录
path.data: /opt/product/data/elk/elasticsearchdata
network.host: 0.0.0.0
在/opt/product/data/elk目录 创建 elasticsearchdata 目录
</code></pre></li>
<li><p>运行容器 </p>
<pre><code>docker run --name elasticsearch --privileged --restart=always -d -ti -v /opt/product/data:/opt/product/data -p 9200:9200 -p 9300:9300 elasticsearch:v1.0 /bin/bash
</code></pre><p>  -&gt; 访问：ip:9200/</p>
</li>
</ul>
<h2 id="logstash"><a href="#logstash" class="headerlink" title="logstash"></a>logstash</h2><hr>
<ul>
<li><p>准备logstash    </p>
<pre><code>https://www.elastic.co/downloads/logstash    
</code></pre></li>
<li><p>准备Dockerfile</p>
<pre><code>FROM elkbase:v1.0
MAINTAINER Yampery&lt;yampery@163.com&gt;
VOLUME [ &quot;/opt/product/data/&quot; ]
ADD ./tools /opt/product/
ADD build.sh /root/
RUN chmod +x /root/build.sh
EXPOSE 5044
EXPOSE 4560
EXPOSE 8080
ENTRYPOINT [&quot;/root/build.sh&quot;]
CMD [&quot;/usr/sbin/init&quot;]
</code></pre></li>
<li><p>准备脚本 build.sh</p>
<pre><code>#!/bin/bash
export JAVA_HOME=/opt/product/tools/jdk-9.0.1
export PATH=$JAVA_HOME/bin:$PATH
JAVA_OPTS=&quot;$JAVA_OPTS -Dfile.encoding=UTF8  -Duser.timezone=GMT+08&quot;
cd /opt/product/logstash-6.0.0/config/
rm -rf logstash.yml
cp /opt/product/data/elk/logstash.yml logstash.yml
/opt/product/logstash-6.0.0/bin/logstash -f /opt/product/data/elk/logstash.conf
</code></pre></li>
<li><p>目录结构</p>
<pre><code>|-elk
    |-logstash
        |-tools
        |--Dockerfile
        |--build.sh
</code></pre></li>
<li><p>构建镜像</p>
<pre><code>elk/logstash$ docker build -f logstash:v1.0 .
</code></pre></li>
<li><p>配置logstash</p>
<pre><code>// 在/opt/product/data/elk目录下创建logstash.conf
input {     
   beats {
    port =&gt; &quot;5044&quot;
   }
}
output {
   elasticsearch {
       hosts =&gt; [&quot;elasticsearch的ip:9200&quot;]
       index =&gt; &quot;logstash-tomcat-accesslog-%{+YYYY.MM.dd}&quot;
    }       
}
// 将logstash本身的logstash.yml 拷贝到/opt/product/data/elk目录下
// 在/opt/product/data/elk目录下建立 logstashdata目录
</code></pre></li>
<li><p>启动</p>
<pre><code>docker run --name logstash --restart=always -d -ti -v /opt/product/data:/opt/product/data -p 5044:5044 -p 4560:4560 -p 9090:9090 logstash:v1.0 /bin/bash
</code></pre></li>
</ul>
<h2 id="kibana"><a href="#kibana" class="headerlink" title="kibana"></a>kibana</h2><hr>
<ul>
<li><p>准备kibana </p>
<pre><code>https://artifacts.elastic.co/downloads/kibana/kibana-6.0.0-linux-x86_64.tar.gz
</code></pre></li>
<li><p>准备Dockerfile</p>
<pre><code>FROM elkbase:v1.0
MAINTAINER Yampery&lt;yampery@163.com&gt;
VOLUME [ &quot;/opt/product/data/&quot; ]
ADD ./tools /opt/product/
ADD build.sh /root/
RUN chmod +x /root/build.sh
EXPOSE 5601
ENTRYPOINT [&quot;/root/build.sh&quot;]
CMD [&quot;/usr/sbin/init&quot;]
</code></pre></li>
<li><p>准备脚本 build.sh</p>
<pre><code>#!/bin/bash 
export JAVA_HOME=/opt/product/tools/jdk-9.0.1
export PATH=$JAVA_HOME/bin:$PATH
cd /opt/product/kibana-6.0.0/config/
rm -rf kibana.yml
ln -s /opt/product/data/elk/kibana.yml . 
cd /opt/product/kibana-6.0.0/
rm -rf data
ln -s  /opt/product/data/elk/kibanadata /opt/product/kibana-6.0.0/data
/opt/product/kibana-6.0.0/bin/kibana
</code></pre></li>
<li><p>构建镜像</p>
<pre><code>elk/kibana$ docker build -t kibana:v1.0 .
</code></pre></li>
<li><p>配置kibana</p>
<pre><code>// 复制kibana.yml到/opt/product/data/elk 下
server.port: 5601
server.host: &quot;0.0.0.0&quot;
elasticsearch.url: &quot;http://ip:9200&quot;
</code></pre></li>
<li><p>启动</p>
<pre><code>docker run --name kibana -d -ti -v /opt/product/data:/opt/product/data -p 5601:5601  kibana:v1.0 /bin/bash
</code></pre></li>
<li><p>访问</p>
<pre><code>ip:5601/
</code></pre></li>
</ul>
<h2 id="FileBeat"><a href="#FileBeat" class="headerlink" title="FileBeat"></a>FileBeat</h2><hr>
<ul>
<li><p>准备FileBeat</p>
<pre><code>https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-6.0.0-linux-x86_64.tar.gz
</code></pre></li>
<li><p>准备Dockerfile</p>
<pre><code>FROM elkbase:v1.0
MAINTAINER Yampery&lt;yampery@163.com&gt;
VOLUME [ &quot;/opt/product/data/&quot; ]
ADD ./tools /opt/product/
ADD build.sh /root/
RUN chmod +x /root/build.sh
ENTRYPOINT [&quot;/root/build.sh&quot;]
CMD [&quot;/usr/sbin/init&quot;]
</code></pre></li>
<li><p>准备脚本 build.sh</p>
<pre><code>#!/bin/bash
export JAVA_HOME=/opt/product/tools/jdk-9.0.1
export PATH=$JAVA_HOME/bin:$PATH
cd /opt/product/filebeat-6.0.0/
rm -rf filebeat.yml
ln -s /opt/product/data/elk/filebeat.yml . 
rm -rf data 
ln -s /opt/product/data/elk/filebeatdata /opt/product/filebeat-6.0.0/data
/opt/product/filebeat-6.0.0/filebeat -e -c filebeat.yml
</code></pre></li>
<li><p>构建镜像</p>
<pre><code>elk/filebeat$ docker build -t filebeat:v1.0 .
</code></pre></li>
<li><p>配置filebeat</p>
<pre><code>// 在/opt/product/data/elk目录下 创建filebeat.yml
filebeat.prospectors:
  - input_type: log
    document_type: tomcataccess
  paths:
     - /opt/product/data/logs/tomcat/localhost_access_log*.txt
     - /opt/product/data/epg2logs/tomcat/localhost_access_log*.txt
output.logstash:
  // The Logstash hosts
  hosts: [&quot;ip:5044&quot;]

 // 在/opt/product/data/elk 目录下创建filebeatdata
</code></pre></li>
</ul>
<ul>
<li><p>启动</p>
<pre><code>docker run --name filebeat -d -ti -v /opt/product/data:/opt/product/data filebeat:v1.0 /bin/bash
</code></pre></li>
</ul>
<h2 id="x-pack"><a href="#x-pack" class="headerlink" title="x-pack"></a>x-pack</h2><ul>
<li><p>安装    </p>
<pre><code>./elasticsearch-plugin install x-pack
</code></pre></li>
<li><p>设置密码 </p>
</li>
</ul>
<p><a href="https://www.elastic.co/guide/en/x-pack/current/setting-up-authentication.html#set-built-in-user-passwords" title="es官网参考" target="_blank" rel="noopener">https://www.elastic.co/guide/en/x-pack/current/setting-up-authentication.html#set-built-in-user-passwords</a></p>
<pre><code>./setup-passwords interactive
    Enter password for [elastic]:
    Reenter password for [elastic]:
    Enter password for [kibana]:
    Reenter password for [kibana]:
    Enter password for [logstash_system]:
    Reenter password for [logstash_system]:
    Changed password for user [kibana]
    Changed password for user [logstash_system]
    Changed password for user [elastic]
</code></pre><ul>
<li><p>logstash配置</p>
<pre><code>input { stdin { } }
output {
  elasticsearch {
    hosts =&gt; [&quot;192.168.107.23:9200&quot;]
    user =&gt; elastic
    password =&gt; elastic
  }
  stdout { codec =&gt; rubydebug }
}
</code></pre><p><em>同理，kibana也可以配置，调用es接口也需要用户密码</em></p>
</li>
</ul>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><hr>
<p><em>脚本和启动项参数中的/opt/product/data均以自己要设定的挂载目录一致</em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/05/ambari/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yampery">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天尽头，回眸望红尘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/05/ambari/" itemprop="url">ambari搭建大数据平台</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-05T14:47:07+08:00">
                2019-01-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2019/01/05/ambari/" class="leancloud_visitors" data-flag-title="ambari搭建大数据平台">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="准备节点"><a href="#准备节点" class="headerlink" title="准备节点"></a>准备节点</h2><ul>
<li>node1: yum源，httpd，mariadb和java8环境</li>
<li>node2: java8环境</li>
<li>node3: java8环境</li>
<li>node4: java8环境</li>
</ul>
<p>将主机名-ip映射配置到每个节点</p>
<pre><code>/etc/hosts

127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.107.74 node1
192.168.107.83 node2
192.168.107.105 node3
192.168.107.131 node4
</code></pre><h2 id="免秘钥登录"><a href="#免秘钥登录" class="headerlink" title="免秘钥登录"></a>免秘钥登录</h2><ol>
<li><p>在每个节点上生成ssh秘钥</p>
 <figure class="highlight plain"><figcaption><span>-t rsa -P '' -f ~/.ssh/id_rsa</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">	</span><br></pre></td></tr></table></figure>
</li>
<li><p>将主节点公钥依次发送到其余节点</p>
 <figure class="highlight plain"><figcaption><span>.ssh/id_rsa.pub root@node2:~/</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">	</span><br></pre></td></tr></table></figure>
</li>
<li><p>将主节点上的公钥追加到其他节点~/.ssh/authorized_keys</p>
 <figure class="highlight plain"><figcaption><span>cat id_rsa.pub >> ~/.ssh/authorized_keys && cat id_rsa.pub >> ~/.ssh/authorized_keys && chmod 0600 ~/.ssh/authorized_keys</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">	</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试免秘钥登录</p>
 <figure class="highlight plain"><figcaption><span>root@node2</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">	</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="关闭Selinux和防火墙"><a href="#关闭Selinux和防火墙" class="headerlink" title="关闭Selinux和防火墙"></a>关闭Selinux和防火墙</h2><pre><code>vim /etc/sysconfig/selinux
selinux=disalbed

systemctl stop firewalld
systemctl disable firewalld
</code></pre><h2 id="时间同步"><a href="#时间同步" class="headerlink" title="时间同步"></a>时间同步</h2><blockquote>
<p>如果节点上时间不正确，则：</p>
</blockquote>
<pre><code># 安装ntpdate工具 
yum -y install ntp ntpdate  
# 设置系统时间与网络时间同步   
ntpdate cn.pool.ntp.org
# 将系统时间写入硬件时间
hwclock --systohc
</code></pre><h3 id="安装nscd"><a href="#安装nscd" class="headerlink" title="安装nscd"></a>安装nscd</h3><blockquote>
<p>由于ambari server和client之间要通信，为了减轻dns压力使用nscd缓存</p>
</blockquote>
<pre><code>yum install -y nscd
systemctl enable nscd &amp;&amp; systemctl start nscd
</code></pre><h2 id="安装jdk"><a href="#安装jdk" class="headerlink" title="安装jdk"></a>安装jdk</h2><pre><code>略
</code></pre><h2 id="配置本地仓库"><a href="#配置本地仓库" class="headerlink" title="配置本地仓库"></a>配置本地仓库</h2><ol>
<li><p>安装yum-utils</p>
 <figure class="highlight plain"><figcaption><span>install yum-utils createrepo</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">	</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建HTTP服务</p>
 <figure class="highlight plain"><figcaption><span>install httpd -y</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">	</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载源，根据自己想要的版本更改</p>
<p> 将repo文件放在/etc/yum.repos.d/ 目录下，等会配置，tgz文件放在http服务器下：/var/www/html下</p>
<pre><code>wget http://public-repo-1.hortonworks.com/ambari/centos7/2.x/updates/2.6.1.0/ambari.repo
wget http://public-repo-1.hortonworks.com/HDP/centos7/2.x/updates/2.6.4.0/hdp.repo
wget http://public-repo-1.hortonworks.com/ambari/centos7/2.x/updates/2.6.1.0/ambari-2.6.1.0-centos7.tar.gz
wget http://public-repo-1.hortonworks.com/HDP-UTILS-1.1.0.22/repos/centos7/HDP-UTILS-1.1.0.22-centos7.tar.gz
wget http://public-repo-1.hortonworks.com/HDP-GPL/centos7/2.x/updates/2.6.4.0/HDP-GPL-2.6.4.0-centos7-rpm.tar.gz
wget http://public-repo-1.hortonworks.com/HDP/centos7/2.x/updates/2.6.4.0/HDP-2.6.4.0-centos7-rpm.tar.gz
</code></pre><p> 将以上tgz文件解压在/var/www/html下</p>
</li>
<li><p>启动httpd测试访问</p>
<p> systemctl start httpd
 访问：<a href="http://node1/ambari" target="_blank" rel="noopener">http://node1/ambari</a>, <a href="http://node1/HDP" target="_blank" rel="noopener">http://node1/HDP</a>, <a href="http://node1/HDP-UTILS.." target="_blank" rel="noopener">http://node1/HDP-UTILS..</a>.</p>
</li>
<li><p>配置yum源</p>
<ul>
<li><p>更改/etc/yum.repos.d/下刚才下载的文件，将源路径指向node1</p>
<p>vi /etc/yum.repos.d/hdp.repo</p>
<p>  [HDP-2.6.4.0]
  name=HDP Version - HDP-2.6.4.0
  baseurl=<a href="http://node1/HDP/centos7/2.6.4.0-91" target="_blank" rel="noopener">http://node1/HDP/centos7/2.6.4.0-91</a>
  gpgcheck=1
  gpgkey=<a href="http://node1/HDP/centos7/2.6.4.0-91/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins" target="_blank" rel="noopener">http://node1/HDP/centos7/2.6.4.0-91/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins</a>
  enabled=1
  priority=1</p>
<p>  [HDP-UTILS-1.1.0.22]
  name=HDP-UTILS Version - HDP-UTILS-1.1.0.22
  baseurl=<a href="http://node1/HDP-UTILS/centos7/1.1.0.22" target="_blank" rel="noopener">http://node1/HDP-UTILS/centos7/1.1.0.22</a>
  gpgcheck=1
  gpgkey=<a href="http://node1/HDP-UTILS/centos7/1.1.0.22/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins" target="_blank" rel="noopener">http://node1/HDP-UTILS/centos7/1.1.0.22/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins</a>
  enabled=1
  priority=1</p>
<p>  [HDP-GPL-2.6.4.0]
  name=HDP-GPL Version - HDP-GPL-2.6.4.0
  baseurl=<a href="http://node1/HDP-GPL/centos7/2.6.4.0-91" target="_blank" rel="noopener">http://node1/HDP-GPL/centos7/2.6.4.0-91</a>
  gpgcheck=1
  gpgkey=<a href="http://node1/HDP-GPL/centos7/2.6.4.0-91/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins" target="_blank" rel="noopener">http://node1/HDP-GPL/centos7/2.6.4.0-91/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins</a>
  enabled=1
  priority=1</p>
<p>vi /etc/yum.repos.d/hdp.repo</p>
<p>  [ambari-2.6.1.0]
  name=ambari Version - ambari-2.6.1.0
  baseurl=<a href="http://node1/ambari/centos7/2.6.1.0-143" target="_blank" rel="noopener">http://node1/ambari/centos7/2.6.1.0-143</a>
  gpgcheck=1
  gpgkey=<a href="http://node1/ambari/centos7/2.6.1.0-143/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins" target="_blank" rel="noopener">http://node1/ambari/centos7/2.6.1.0-143/RPM-GPG-KEY/RPM-GPG-KEY-Jenkins</a>
  enabled=1
  priority=1</p>
</li>
<li><p>缓存yum源</p>
<figure class="highlight plain"><figcaption><span>clean all && yum makecache fast</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">	</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<h2 id="安装ambar"><a href="#安装ambar" class="headerlink" title="安装ambar"></a>安装ambar</h2><h3 id="安装mariadb"><a href="#安装mariadb" class="headerlink" title="安装mariadb"></a>安装mariadb</h3><pre><code>yum install mariadb-server -y
systemctl start mariadb
mysql_secure_installation # 直接确定，然后设置root密码

# 创建数据库：

MariaDB [(none)]&gt; create database ambari default character set utf8;
Query OK, 1 row affected (0.00 sec)

MariaDB [(none)]&gt; grant all on ambari.* to ambari@localhost identified by &apos;ambari&apos;;
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]&gt; grant all on ambari.* to ambari@&apos;%&apos; identified by &apos;ambari&apos;;
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]&gt; create database hive default character set utf8;
Query OK, 1 row affected (0.00 sec)

MariaDB [(none)]&gt; grant all on hive.* to hive@localhost identified by &apos;ambari&apos;;
Query OK, 0 rows affected (0.00 sec)

MariaDB [(none)]&gt; grant all on hive.* to hive@&apos;%&apos; identified by &apos;ambari&apos;;
</code></pre><h3 id="安装ambari-server"><a href="#安装ambari-server" class="headerlink" title="安装ambari-server"></a>安装ambari-server</h3><pre><code>yum install ambari-server -y
ambari-server setup
</code></pre><blockquote>
<p>安装过程中要选择数据库，如果出现如下警告：按照提示放入jdbc驱动jar包，并配置路径即可
WARNING: Before starting Ambari Server, you must copy the MySQL JDBC driver JAR file to /usr/&gt; share/java and set property “server.jdbc.driver.path=[path/to/custom_jdbc_driver]” in ambari.properties.</p>
</blockquote>
<pre><code>vim /etc/ambari-server/conf/ambari.properties 
server.jdbc.driver.path=/usr/share/java/mysql-connector-java-5.1.34.jar

Using python  /usr/bin/python
Setup ambari-server
Checking SELinux...
SELinux status is &apos;enabled&apos;
SELinux mode is &apos;permissive&apos;
WARNING: SELinux is set to &apos;permissive&apos; mode and temporarily disabled.
OK to continue [y/n] (y)? y
Customize user account for ambari-server daemon [y/n] (n)? y
Enter user account for ambari-server daemon (root):ambari
Adjusting ambari-server permissions and ownership...
Checking firewall status...
Checking JDK...
Do you want to change Oracle JDK [y/n] (n)? y
[1] Oracle JDK 1.8 + Java Cryptography Extension (JCE) Policy Files 8
[2] Oracle JDK 1.7 + Java Cryptography Extension (JCE) Policy Files 7
[3] Custom JDK
==============================================================================
Enter choice (1): 3
WARNING: JDK must be installed on all hosts and JAVA_HOME must be valid on all hosts.
WARNING: JCE Policy files are required for configuring Kerberos security. If you plan to use Kerberos,please make sure JCE Unlimited Strength Jurisdiction Policy Files are valid on all hosts.
Path to JAVA_HOME: /home/java/jre
Validating JDK on Ambari Server...done.
Checking GPL software agreement...
GPL License for LZO: https://www.gnu.org/licenses/old-licenses/gpl-2.0.en.html
Enable Ambari Server to download and install GPL Licensed LZO packages [y/n] (n)? n
Completing setup...
Configuring database...
Enter advanced database configuration [y/n] (n)? y
Configuring database...
==============================================================================
Choose one of the following options:
[1] - PostgreSQL (Embedded)
[2] - Oracle
[3] - MySQL / MariaDB
[4] - PostgreSQL
[5] - Microsoft SQL Server (Tech Preview)
[6] - SQL Anywhere
[7] - BDB
==============================================================================
Enter choice (3): 3
Hostname (localhost): 
Port (3306): 
Database name (ambari): 
Username (ambari): 
Enter Database Password (ambari): 
Configuring ambari database...
Configuring remote database connection properties...
WARNING: Before starting Ambari Server, you must run the following DDL against the database to create the schema: /var/lib/ambari-server/resources/Ambari-DDL-MySQL-CREATE.sql
Proceed with configuring remote database connection properties [y/n] (y)? n^Hy
input not recognized, please try again: 
Proceed with configuring remote database connection properties [y/n] (y)? y
Extracting system views...
ambari-admin-2.6.1.0.143.jar
...........
Adjusting ambari-server permissions and ownership...
Ambari Server &apos;setup&apos; completed successfully.
</code></pre><h3 id="启动ambari-server"><a href="#启动ambari-server" class="headerlink" title="启动ambari-server"></a>启动ambari-server</h3><pre><code>ambari-server start
</code></pre><blockquote>
<p>启动失败，查看日志：tail /var/log/ambari-server.log
Caused by: com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: Table ‘ambari.metainfo’ doesn’t exist</p>
</blockquote>
<pre><code>导入表后再次启动
mysql -uroot -p ambari &lt; /var/lib/ambari-server/resources/Ambari-DDL-MySQL-CREATE.sql
</code></pre><ul>
<li><p>测试访问：node1:8080</p>
<p>  默认监听8080端口，如果失败，查看日志。使用默认账户admin/admin登录，界面如下</p>
<p>  <img src="https://i.imgur.com/Qw3fYfC.png" alt="管理界面"></p>
</li>
</ul>
<h2 id="创建数据平台"><a href="#创建数据平台" class="headerlink" title="创建数据平台"></a>创建数据平台</h2><h3 id="选择Launch-Install-Wizard"><a href="#选择Launch-Install-Wizard" class="headerlink" title="选择Launch Install Wizard"></a>选择Launch Install Wizard</h3><pre><code>![step0](https://i.imgur.com/ly0mo2a.png)
</code></pre><h3 id="配置为本地仓库"><a href="#配置为本地仓库" class="headerlink" title="配置为本地仓库"></a>配置为本地仓库</h3><pre><code>![配置本地仓库](https://i.imgur.com/AAJH4Tv.png)
</code></pre><h3 id="添加主机节点"><a href="#添加主机节点" class="headerlink" title="添加主机节点"></a>添加主机节点</h3><pre><code>    The user account used to install the Ambari Agent on the target host(s) via SSH. This user must be set up with passwordless SSH and sudo access on all the target host(s)
    添加主节点node1私钥id_rsa，必须能够免秘钥登录其他节点安装ambari agent
![配置节点](https://i.imgur.com/yY2LyF4.png)
</code></pre><h3 id="Confirm-Hosts"><a href="#Confirm-Hosts" class="headerlink" title="Confirm Hosts"></a>Confirm Hosts</h3><pre><code>在这一步可能碰见很多问题，执行之前一定要用tail -f实时查看日志，注意查看的是

<figure class="highlight plain"><figcaption><span>-f</span><a href="/var/log/ambari-server/ambari-server.log">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">	</span><br></pre></td></tr></table></figure>

&gt; 错误示例一：

&gt; 查看openssl版本没有问题，更改所有ambari-client配置：在[security]单元下添加：force_https_protocol=PROTOCOL_TLSv1_2

<figure class="highlight plain"><figcaption><span>/etc/ambari-agent/conf/ambari-agent.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">	</span><br></pre></td></tr></table></figure>

    ERROR 2018-06-17 12:50:36,164 NetUtil.py:96 - EOF occurred in violation of protocol (_ssl.c:765)
    ERROR 2018-06-17 12:50:36,164 NetUtil.py:97 - SSLError: Failed to connect. Please check openssl library versions. 
    ......
    ......
    INFO 2018-06-17 12:50:35,295 main.py:437 - Connecting to Ambari server at https://node1:8440 (192.168.107.74)
    INFO 2018-06-17 12:50:35,295 NetUtil.py:70 - Connecting to https://node1:8440/ca
    ERROR 2018-06-17 12:50:36,164 NetUtil.py:96 - EOF occurred in violation of protocol (_ssl.c:765)
    ERROR 2018-06-17 12:50:36,164 NetUtil.py:97 - SSLError: Failed to connect. Please check openssl library versions. 
    Refer to: https://bugzilla.redhat.com/show_bug.cgi?id=1022468 for more details.

&gt; 错误示例二：

&gt; 不能创建文件夹，赋予权限，ambari-server在确认主机和分配服务均需要被操作

<figure class="highlight plain"><figcaption><span>-R ambari</span><a href="/var/run/ambari-server">link</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">	</span><br></pre></td></tr></table></figure>

    17 Jun 2018 12:20:23,259 ERROR [Thread-35] BSRunner:441 - java.io.FileNotFoundException: /var/run/ambari-server/bootstrap/1/node1.done (No such file or directory)
    17 Jun 2018 12:20:23,260  WARN [Thread-35] BSRunner:401 - File does not exist: /var/run/ambari-server/bootstrap/1/sshKey
    17 Jun 2018 12:41:20,217  INFO [Thread-37] BSRunner:189 - Kicking off the scheduler for polling on logs in /var/run/ambari-server/bootstrap/1

&gt; 错误示例三：

&gt; 注意主节点信任主机.ssh/known_hosts以及免秘钥登录除了客户机也必须要有自己，如果成功则如下：
</code></pre><p><img src="https://i.imgur.com/meXkLyF.png" alt="确认主机"></p>
<h3 id="选择服务"><a href="#选择服务" class="headerlink" title="选择服务"></a>选择服务</h3><blockquote>
<p>根据自己系统配置，建议可以一个个添加，比如先添加HDFS、YARN和MapReduce</p>
</blockquote>
<p><img src="https://i.imgur.com/6NR59vZ.png" alt="选择服务"></p>
<h3 id="assign-master"><a href="#assign-master" class="headerlink" title="assign master"></a>assign master</h3><p>相当于做集群配置
<img src="https://i.imgur.com/namV8ua.png" alt="指派master"></p>
<h3 id="主从分配"><a href="#主从分配" class="headerlink" title="主从分配"></a>主从分配</h3><p><img src="https://i.imgur.com/AmndrgO.png" alt="主从分配"></p>
<h3 id="自定义配置"><a href="#自定义配置" class="headerlink" title="自定义配置"></a>自定义配置</h3><p>红色的表示还需要进一步配置，数据库登录，根据提示来即可
之前已经添加了jdbc驱动，因此这里只要执行：
<figure class="highlight plain"><figcaption><span>setup --jdbc-db</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line">![自定义配置](https://i.imgur.com/ZnrSK6B.png)</span><br><span class="line"></span><br><span class="line">## 测试MapReduce</span><br><span class="line">**注意：root用户是不能操作hdfs文件系统的，当然可以更改hdfs-site.xml关闭权限验证，不过建议切换hdfs用户来操作**</span><br></pre></td></tr></table></figure></p>
<pre><code>su hdfs &amp;&amp; cd ~
</code></pre><p><code>`</code></p>
<ul>
<li><p>创建文件wc.txt，同时将文件上传到hdfs</p>
<pre><code>vi wc.txt
    hadoop hello world
    zk hello hadoop
    hbase hive
    zk spark
hadoop fs -mkdir /tmp/input
hadoop fs -put wc.txt /tmp/input
# 执行MapReduce，根据自己的版本和文件选择hdp的示例，或者使用自己的jar包
hadoop jar /usr/hdp/2.6.4.0-91/hadoop-mapreduce/hadoop-mapreduce-examples-2.7.3.2.6.4.0-91.jar wordcount /tmp/input/wc.txt /tmp/output
</code></pre></li>
<li><p>官方示例源码</p>
<p>  <a href="http://hadoop.apache.org/docs/current/hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapReduceTutorial.html#Source_Code" title="官方示例源码" target="_blank" rel="noopener">http://hadoop.apache.org/docs/current/hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapReduceTutorial.html#Source_Code</a></p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/05/cryptic_interceptor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yampery">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="天尽头，回眸望红尘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/05/cryptic_interceptor/" itemprop="url">使用拦截器进行数据加解密</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-05T14:47:07+08:00">
                2019-01-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2019/01/05/cryptic_interceptor/" class="leancloud_visitors" data-flag-title="使用拦截器进行数据加解密">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>本文并非详细探讨AES加解密内容，而是在Spring+Mybatis的项目基础上，以sql拦截器的形式，实现了对数据存取加解密的方案。文章项目示例采用springboot框架，对需要加解密的字段添加注解，sql执行过程中，拦截器进行拦截。可通过配置加解密开关决定是否对字段进行加解密。加密方式AES。</p>
</blockquote>
<p>文章并未列出所有源码，依赖包等详细配置，在源码中有具体的sql脚本等文件，<a href="https://github.com/Yampery/cryptic-data" target="_blank" rel="noopener">点击访问项目源码。</a></p>
<ul>
<li>源码框架<blockquote>
<p>java8   springboot   mybatis   gradle</p>
</blockquote>
</li>
</ul>
<hr>
<h2 id="加解密工具"><a href="#加解密工具" class="headerlink" title="加解密工具"></a>加解密工具</h2><blockquote>
<p>方法generateAESKey()生成128位秘钥，以16进制字符串保存，从配置文件读取，以单例模式初始化加解密工具，保证项目运行过程中对象不会被重新创建，避免多次初始化Cipher。加解密方法详见代码如下。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@decription</span> ADESUtils</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;字段加解密，使用MySql AES算法&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Yampery</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/4/4 13:10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ADESUtils</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ENCRYPT_TYPE = <span class="string">"AES"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String ENCODING = <span class="string">"UTF-8"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 密盐</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String aesSalt;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ADESUtils adesUtils;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Cipher encryptCipher;    <span class="comment">// 加密cipher</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Cipher decryptChipher;   <span class="comment">// 解密chipher</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加解密开关，从配置获取</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String CRYPTIC_SWITCH;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从配置中获取秘钥</span></span><br><span class="line"><span class="comment">     * :默认值填写自己生成的秘钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;sys.aes.salt:0&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAESSalt</span><span class="params">(String key)</span></span>&#123;</span><br><span class="line">        ADESUtils.aesSalt = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取开关</span></span><br><span class="line"><span class="comment">     * 默认为不加密</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> val</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;sys.aes.switch:0&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCrypticSwitch</span><span class="params">(String val)</span> </span>&#123;</span><br><span class="line">        ADESUtils.CRYPTIC_SWITCH = val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * encryptCipher、decryptChipher初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            encryptCipher = Cipher.getInstance(ENCRYPT_TYPE);</span><br><span class="line">            decryptChipher = Cipher.getInstance(ENCRYPT_TYPE);</span><br><span class="line">            encryptCipher.init(Cipher.ENCRYPT_MODE, generateMySQLAESKey(aesSalt));</span><br><span class="line">            decryptChipher.init(Cipher.DECRYPT_MODE, generateMySQLAESKey(aesSalt));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidKeyException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchPaddingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ADESUtils</span><span class="params">()</span> </span>&#123;  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取单例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ADESUtils <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(adesUtils == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">// 当需要创建的时候在加锁</span></span><br><span class="line">            <span class="keyword">synchronized</span>(ADESUtils.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (adesUtils == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    adesUtils = <span class="keyword">new</span> ADESUtils();</span><br><span class="line">                    init();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> adesUtils;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对明文加密</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pString</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">encrypt</span><span class="params">(String pString)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(pString) || StringUtils.equals(<span class="string">"0"</span>, CRYPTIC_SWITCH))</span><br><span class="line">            <span class="keyword">return</span> StringUtils.trimToEmpty(pString);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(Hex.encodeHex(encryptCipher.doFinal(pString.getBytes(ENCODING)))).toUpperCase();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> pString;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对密文解密</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> eString</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">decrypt</span><span class="params">(String eString)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(eString) || StringUtils.equals(<span class="string">"0"</span>, CRYPTIC_SWITCH))</span><br><span class="line">            <span class="keyword">return</span> StringUtils.trimToEmpty(eString);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(decryptChipher.doFinal(Hex.decodeHex(eString.toCharArray())));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> eString;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 产生mysql-aes_encrypt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 加密的密盐</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SecretKeySpec <span class="title">generateMySQLAESKey</span><span class="params">(<span class="keyword">final</span> String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">byte</span>[] finalKey = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">16</span>];</span><br><span class="line">            <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">byte</span> b : Hex.decodeHex(key.toCharArray()))</span><br><span class="line">                finalKey[i++ % <span class="number">16</span>] ^= b;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SecretKeySpec(finalKey, <span class="string">"AES"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成秘钥(128位)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">generateAESKey</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//实例化</span></span><br><span class="line">        KeyGenerator kgen = KeyGenerator.getInstance(<span class="string">"AES"</span>);</span><br><span class="line">        <span class="comment">//设置密钥长度</span></span><br><span class="line">        kgen.init(<span class="number">128</span>);</span><br><span class="line">        <span class="comment">//生成密钥</span></span><br><span class="line">        SecretKey skey = kgen.generateKey();</span><br><span class="line">        <span class="comment">// 转为16进制字串</span></span><br><span class="line">        String key = <span class="keyword">new</span> String(Hex.encodeHex(skey.getEncoded()));</span><br><span class="line">        <span class="comment">//返回密钥的16进制字串</span></span><br><span class="line">        <span class="keyword">return</span> key.toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="加解密字段注解"><a href="#加解密字段注解" class="headerlink" title="加解密字段注解"></a>加解密字段注解</h2><blockquote>
<p>注解标识字段是否需要加密或者解密，用于通过反射获取需要进行加解密的字段，防止需求变动，将加密和解密注解分开。</p>
</blockquote>
<h3 id="加密注解"><a href="#加密注解" class="headerlink" title="加密注解"></a>加密注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@decription</span> EncryptField</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;字段加密注解&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Yampery</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/10/24 13:01</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.FIELD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EncryptField &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解密注解"><a href="#解密注解" class="headerlink" title="解密注解"></a>解密注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@decription</span> DecryptField</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;字段解密注解&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Yampery</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/10/24 13:05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.FIELD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DecryptField &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="封装加解密工具"><a href="#封装加解密工具" class="headerlink" title="封装加解密工具"></a>封装加解密工具</h2><blockquote>
<p>为了在项目中方便使用，将上节中的加解密工具进行封装，封装后的工具可以作用于对象，通过反射获取注解，而对原对象进行改变。另外，项目中也实现了对象的自加解密CrypticPojo，原理是CrypticPojo实现clone方法，并在内部实现加解密方法，需要进行字段加解密的业务对象只需要继承CrypticPojo，每次返回调用一次克隆并加密方法即可，具体见源码。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@decription</span> CryptPojoUtils</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;对象加解密工具</span></span><br><span class="line"><span class="comment"> * 其子类可以通过调用&lt;tt&gt;encrypt(T t)&lt;/tt&gt;方法实现自加密，返回参数类型；</span></span><br><span class="line"><span class="comment"> * 调用&lt;tt&gt;decrypt(T t)&lt;/tt&gt;实现自解密，返回参数类型；</span></span><br><span class="line"><span class="comment"> * &lt;tt&gt;encrypt&lt;/tt&gt;对注解&#123;<span class="doctag">@link</span> EncryptField&#125;字段有效；</span></span><br><span class="line"><span class="comment"> * &lt;tt&gt;decrypt&lt;/tt&gt;对注解&#123;<span class="doctag">@link</span> DecryptField&#125;字段有效。&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Yampery</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/10/24 13:36</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CryptPojoUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对对象t加密</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">encrypt</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">        Field[] declaredFields = t.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (declaredFields != <span class="keyword">null</span> &amp;&amp; declaredFields.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Field field : declaredFields) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (field.isAnnotationPresent(EncryptField.class) &amp;&amp; field.getType().toString().endsWith(<span class="string">"String"</span>)) &#123;</span><br><span class="line">                        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        String fieldValue = (String) field.get(t);</span><br><span class="line">                        <span class="keyword">if</span> (StringUtils.isNotEmpty(fieldValue)) &#123;</span><br><span class="line">                            field.set(t, ADESUtils.getInstance().encrypt(fieldValue));</span><br><span class="line">                        &#125;</span><br><span class="line">                        field.setAccessible(<span class="keyword">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对象解密</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">decrypt</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">        Field[] declaredFields = t.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (declaredFields != <span class="keyword">null</span> &amp;&amp; declaredFields.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Field field : declaredFields) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (field.isAnnotationPresent(DecryptField.class) &amp;&amp; field.getType().toString().endsWith(<span class="string">"String"</span>)) &#123;</span><br><span class="line">                        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        String fieldValue = (String)field.get(t);</span><br><span class="line">                        <span class="keyword">if</span>(StringUtils.isNotEmpty(fieldValue)) &#123;</span><br><span class="line">                            field.set(t, ADESUtils.getInstance().decrypt(fieldValue));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对含注解字段解密</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">decryptField</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">        Field[] declaredFields = t.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (declaredFields != <span class="keyword">null</span> &amp;&amp; declaredFields.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Field field : declaredFields) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (field.isAnnotationPresent(DecryptField.class) &amp;&amp; field.getType().toString().endsWith(<span class="string">"String"</span>)) &#123;</span><br><span class="line">                        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        String fieldValue = (String)field.get(t);</span><br><span class="line">                        <span class="keyword">if</span>(StringUtils.isNotEmpty(fieldValue)) &#123;</span><br><span class="line">                            field.set(t, ADESUtils.getInstance().decrypt(fieldValue));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// return t;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对含注解字段加密</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">encryptField</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">        Field[] declaredFields = t.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (declaredFields != <span class="keyword">null</span> &amp;&amp; declaredFields.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Field field : declaredFields) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (field.isAnnotationPresent(EncryptField.class) &amp;&amp; field.getType().toString().endsWith(<span class="string">"String"</span>)) &#123;</span><br><span class="line">                        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        String fieldValue = (String)field.get(t);</span><br><span class="line">                        <span class="keyword">if</span>(StringUtils.isNotEmpty(fieldValue)) &#123;</span><br><span class="line">                            field.set(t, ADESUtils.getInstance().encrypt(fieldValue));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 隐藏号码中间4位</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> t</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">hidePhone</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">        Field[] declaredFields = t.getClass().getDeclaredFields();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (declaredFields != <span class="keyword">null</span> &amp;&amp; declaredFields.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Field field : declaredFields) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (field.isAnnotationPresent(DecryptField.class) &amp;&amp; field.getType().toString().endsWith(<span class="string">"String"</span>)) &#123;</span><br><span class="line">                        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                        String fieldValue = (String)field.get(t);</span><br><span class="line">                        <span class="keyword">if</span>(StringUtils.isNotEmpty(fieldValue)) &#123;</span><br><span class="line">                            <span class="comment">// 暂时与解密注解共用一个注解，该注解隐藏手机号中间四位</span></span><br><span class="line">                            field.set(t, StringUtils.overlay(fieldValue, <span class="string">"****"</span>, <span class="number">3</span>, <span class="number">7</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h2><blockquote>
<p>使用sql拦截器处理加解密基本是对项目影响比较小的。该拦截器通过拦截sql，对写入数据和查询结果进行重写，然后再放行从而更改对象。
关于sql语句参数，文章中并没有在拦截器处理，而是使用一个LinkedMap封装了查询参数，在封装的过程中会对字段进行加密。
关于springboot中和spring中拦截器使用的区别下文将会介绍。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@decription</span> DBInterceptor</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;实现Mybatis拦截器，用于拦截修改，插入和返回需要加密或者解密的对象&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Yampery</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/4/4 14:17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Intercepts</span>(&#123;</span><br><span class="line">        <span class="meta">@Signature</span>(type=Executor.class,method=<span class="string">"update"</span>,args=&#123;MappedStatement.class,Object.class&#125;),</span><br><span class="line">        <span class="meta">@Signature</span>(type=Executor.class,method=<span class="string">"query"</span>,args=&#123;MappedStatement.class,Object.class,RowBounds.class,ResultHandler.class&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DBInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(DBInterceptor.class);</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;sys.aes.switch&#125;"</span>) <span class="keyword">private</span> String CRYPTIC_SWITCH;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        MappedStatement statement = (MappedStatement) invocation.getArgs()[<span class="number">0</span>];</span><br><span class="line">        String methodName = invocation.getMethod().getName();</span><br><span class="line">        Object parameter = invocation.getArgs()[<span class="number">1</span>];</span><br><span class="line">        BoundSql sql = statement.getBoundSql(parameter);</span><br><span class="line">        logger.info(<span class="string">"sql is: &#123;&#125;"</span>, sql.getSql());</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@TODO</span> 处理查询</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.equalsIgnoreCase(<span class="string">"query"</span>, methodName)) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 在这里可以处理查询参数，如传递的参数为明文，要按照密文查询</span></span><br><span class="line"><span class="comment">             * 本文选择使用同一参数封装处理方案&#123;<span class="doctag">@link</span> git.yampery.cryptic.common.QueryParams&#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 拦截批量插入操作不仅繁琐，而且为了通用逐一通过反射加密不妥</span></span><br><span class="line"><span class="comment">         * 如果有批量操作，最好在传递参数之前，向list中添加之前就加密</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">"0"</span>.equals(CRYPTIC_SWITCH)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.equalsIgnoreCase(<span class="string">"update"</span>, methodName)</span><br><span class="line">                    || StringUtils.equalsIgnoreCase(<span class="string">"insert"</span>, methodName)) &#123;</span><br><span class="line">                CryptPojoUtils.encryptField(parameter);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object returnValue = invocation.proceed();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">"0"</span>.equals(CRYPTIC_SWITCH)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (returnValue <span class="keyword">instanceof</span> ArrayList&lt;?&gt;) &#123;</span><br><span class="line">                    List&lt;?&gt; list = (ArrayList&lt;?&gt;) returnValue;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> == list || <span class="number">1</span> &gt; list.size())</span><br><span class="line">                        <span class="keyword">return</span> returnValue;</span><br><span class="line">                    Object obj = list.get(<span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> == obj)  <span class="comment">// 这里虽然list不是空，但是返回字符串等有可能为空</span></span><br><span class="line">                        <span class="keyword">return</span> returnValue;</span><br><span class="line">                    <span class="comment">// 判断第一个对象是否有DecryptField注解</span></span><br><span class="line">                    Field[] fields = obj.getClass().getDeclaredFields();</span><br><span class="line">                    <span class="keyword">int</span> len;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> != fields &amp;&amp; <span class="number">0</span> &lt; (len = fields.length)) &#123;</span><br><span class="line">                        <span class="comment">// 标记是否有解密注解</span></span><br><span class="line">                        <span class="keyword">boolean</span> isD = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">                            <span class="comment">/**</span></span><br><span class="line"><span class="comment">                             * 由于返回的是同一种类型列表，因此这里判断出来之后可以保存field的名称</span></span><br><span class="line"><span class="comment">                             * 之后处理所有对象直接按照field名称查找Field从而改之即可</span></span><br><span class="line"><span class="comment">                             * 有可能该类存在多个注解字段，所以需要保存到数组（项目中目前最多是2个）</span></span><br><span class="line"><span class="comment">                             * <span class="doctag">@TODO</span> 保存带DecryptField注解的字段名称到数组，按照名称获取字段并解密</span></span><br><span class="line"><span class="comment">                             * */</span></span><br><span class="line">                            <span class="keyword">if</span> (fields[i].isAnnotationPresent(DecryptField.class)) &#123;</span><br><span class="line">                                isD = <span class="keyword">true</span>;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="comment">/// for end ~</span></span><br><span class="line">                        <span class="keyword">if</span> (isD)  <span class="comment">// 将含有DecryptField注解的字段解密</span></span><br><span class="line">                            list.forEach(l -&gt; CryptPojoUtils.decryptField(l));</span><br><span class="line">                    &#125; <span class="comment">/// if end ~</span></span><br><span class="line">                &#125; <span class="comment">/// if end ~</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 打印异常，由于拦截器本身抛出异常，比如拦截到很奇葩的返回，应算正常</span></span><br><span class="line">            <span class="comment">// 直接返回原结果即可</span></span><br><span class="line">            logger.info(<span class="string">"抛出异常，正常返回==&gt; "</span> + e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> returnValue;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">plugin</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Plugin.wrap(target, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="不同框架配置说明"><a href="#不同框架配置说明" class="headerlink" title="不同框架配置说明"></a>不同框架配置说明</h2><h3 id="springboot下的配置"><a href="#springboot下的配置" class="headerlink" title="springboot下的配置"></a>springboot下的配置</h3><ul>
<li>启动主类需要添加mapper扫描注解</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"git.yampery.cryptic.dao"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(Application.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>配置文件application.properties需要添加映射</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Mybatis</span></span><br><span class="line">mybatis.config-location             =classpath:mybatis/mybatis-config.xml</span><br><span class="line">mybatis.mapper-locations            =classpath:mybatis/mapper/*.xml</span><br><span class="line">mybatis.type-aliases-package        =git.yampery.cryptic.pojo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启debug模式可以在控制台查看springboot加载流程</span></span><br><span class="line"><span class="comment"># debug                               =true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 密盐（使用工具ADESUtils生成）</span></span><br><span class="line">sys.aes.salt                        =4BB90812C2B9B0882A6FA7C203E4717F</span><br><span class="line"><span class="comment"># 加解密开关（1：开启加解密；0：关闭加解密）</span></span><br><span class="line">sys.aes.switch                      =1</span><br></pre></td></tr></table></figure>
<ul>
<li>拦截器会自动扫描，注意@Component注解</li>
</ul>
<h3 id="spring的xml配置"><a href="#spring的xml配置" class="headerlink" title="spring的xml配置"></a>spring的xml配置</h3><ul>
<li>mybatis当然和传统配置一致，在spring上下文配置中添加</li>
<li>拦截器配置，在spring上下文配置文件sqlsessionfactory中</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sqlSessionFactory"</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.SqlSessionFactoryBean"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"configLocation"</span> <span class="attr">value</span>=<span class="string">"classpath:mybatis.xml"</span> /&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- 自动扫描mapping.xml文件 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"mapperLocations"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">value</span>&gt;</span>classpath:mybatis/mapper/*.xml<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"plugins"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">array</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"git.yampery.cryptic.interceptor.DBInterceptor"</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"properties"</span> <span class="attr">value</span>=<span class="string">"property-value"</span>/&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"basePackage"</span> <span class="attr">value</span>=<span class="string">"git.yampery.cryptic.dao"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sqlSessionFactoryBeanName"</span> <span class="attr">value</span>=<span class="string">"sqlSessionFactory"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p><strong>注意：文章中的代码只是部分，源码包含完整的测试和说明，<a href="https://github.com/Yampery/cryptic-data" target="_blank" rel="noopener">点击访问项目源码。</a></strong></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Yampery</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yampery" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:1yampery@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yampery</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("35rGUMRzp5wPN2jmmIUWeBNh-gzGzoHsz", "fmF6mJDmgl0FkqBKX8I2HiGF");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
